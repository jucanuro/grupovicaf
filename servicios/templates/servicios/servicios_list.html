{% extends "base_vicafpro.html" %}
{% load static %}
{% block content %}

<style>
    .bg-geometric {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        z-index: -1; background-color: #ffffff; overflow: hidden;
    }
    .shape-rhombus {
        position: absolute; width: 150px; height: 150px;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(37, 99, 235, 0.02) 100%);
        transform: rotate(45deg); border-radius: 20px; top: 10%; left: -50px;
        animation: float 6s ease-in-out infinite;
    }
    .shape-cylinder {
        position: absolute; width: 60px; height: 200px;
        background: linear-gradient(to bottom, rgba(16, 185, 129, 0.05), transparent);
        border-radius: 100px; bottom: 5%; right: 15%;
        transform: rotate(-20deg); animation: float 8s ease-in-out infinite reverse;
    }
    .shape-pyramid {
        position: absolute; width: 0; height: 0;
        border-left: 100px solid transparent; border-right: 100px solid transparent;
        border-bottom: 170px solid rgba(139, 92, 246, 0.04);
        top: 40%; right: -50px; transform: rotate(15deg);
    }
    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(45deg); }
        50% { transform: translateY(-20px) rotate(48deg); }
    }
    .animated-gradient-text {
        background: linear-gradient(to right, #10B981, #3B82F6, #8B5CF6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-size: 200% auto;
        animation: text-gradient 3s linear infinite alternate;
    }
    @keyframes text-gradient { to { background-position: 200% center; } }
    .glass-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.7);
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.04);
    }
</style>

<div class="bg-geometric">
    <div class="shape-rhombus"></div>
    <div class="shape-cylinder"></div>
    <div class="shape-pyramid"></div>
</div>

<div class="space-y-6 relative z-10">
    <div class="pb-8 mb-4">
        <header class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-6 animate-fade-in-up">
            <div class="relative pl-4 border-l-4 border-emerald-500">
                <h1 class="text-xl font-black tracking-tighter animated-gradient-text uppercase">Catálogo de Servicios</h1>
                <p class="text-slate-500 text-xs font-bold mt-1 uppercase tracking-[0.2em] flex items-center gap-2">
                    <span class="w-8 h-[1px] bg-slate-300"></span> Ensayos y Metrología Avanzada
                </p>
            </div>
            
            <div class="flex flex-col sm:flex-row items-center gap-4 w-full lg:w-auto">
                <div class="relative w-full sm:w-96 group">
                    <div class="absolute inset-0 bg-slate-100 translate-y-1 translate-x-1 -z-10" style="clip-path: polygon(5% 0, 100% 0, 95% 100%, 0 100%);"></div>
                    <div class="relative bg-white border border-slate-300 transition-all focus-within:ring-2 focus-within:ring-blue-600" style="clip-path: polygon(4% 0%, 100% 0%, 96% 100%, 0% 100%);">
                        <i data-lucide="search" class="absolute left-6 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-400"></i>
                        <input type="text" id="searchInput" placeholder="BUSCAR POR NOMBRE O CÓDIGO..." class="w-full pl-12 pr-8 py-3 bg-transparent border-none text-[11px] font-black tracking-widest text-slate-700 placeholder-slate-300 focus:ring-0 outline-none">
                    </div>
                </div>
                <a href="{% url 'servicios:crear_servicio' %}" class="relative inline-flex items-center gap-3 px-8 py-3 bg-slate-900 text-white transition-all duration-300 hover:bg-emerald-600 hover:-translate-y-1 group w-full sm:w-auto justify-center" style="clip-path: polygon(15% 0, 100% 0, 85% 100%, 0 100%);">
                    <i data-lucide="plus-circle" class="w-4 h-4 group-hover:rotate-90 transition-transform duration-500"></i>
                    <span class="text-xs font-black uppercase tracking-[0.2em]">Nuevo Servicio</span>
                </a>
            </div>
        </header>
    </div>

    <div class="relative animate-fade-in-up group/container">
        <div class="absolute inset-0 bg-slate-200/60 translate-y-3 translate-x-1 -z-10" style="clip-path: polygon(0 0, 100% 0, 98% 100%, 2% 100%);"></div>
        <div class="glass-card p-1 overflow-hidden" style="clip-path: polygon(0 0, 100% 0, 98% 100%, 2% 100%); border-radius: 4px;">
            <div class="bg-white/95 backdrop-blur-2xl p-2 md:p-2">
                <div class="overflow-x-auto">
                    <table class="min-w-full text-left border-separate border-spacing-y-3">
                        <thead>
                            <tr class="text-slate-400">
                                <th class="py-4 px-6 font-black text-[9px] uppercase tracking-[0.25em] border-b border-slate-100">Servicio / Ensayo</th>
                                <th class="py-4 px-6 font-black text-[9px] uppercase tracking-[0.25em] border-b border-slate-100">Norma & Método</th>
                                <th class="py-4 px-6 font-black text-[9px] uppercase tracking-[0.25em] border-b border-slate-100">Costo Base</th>
                                <th class="py-4 px-6 font-black text-[9px] uppercase tracking-[0.25em] border-b border-slate-100 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="servicios-table-body">
                            {% for servicio in servicios %}
                            <tr class="group bg-white hover:bg-slate-50/80 transition-all duration-500 shadow-sm border border-slate-100">
                                <td class="py-5 px-6 first:rounded-l-2xl border-y border-l border-slate-50">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 bg-slate-900 flex items-center justify-center text-white font-bold text-[10px] group-hover:bg-emerald-500 transition-all" style="clip-path: polygon(20% 0, 100% 0, 80% 100%, 0 100%);">
                                            {{ servicio.codigo_facturacion|default:"S" }}
                                        </div>
                                        <div>
                                            <p class="font-bold text-slate-800 text-[11px] uppercase tracking-tighter">{{ servicio.nombre }}</p>
                                            <div class="flex items-center gap-2 mt-1">
                                                {% if servicio.esta_acreditado %}
                                                <span class="px-2 py-0.5 bg-emerald-50 text-emerald-600 text-[8px] font-black rounded uppercase border border-emerald-100">Acreditado</span>
                                                {% endif %}
                                                <span class="text-[9px] text-slate-400 font-bold uppercase">{{ servicio.unidad_base }}</span>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td class="py-5 px-6 border-y border-slate-50">
                                    <span class="text-[10px] text-slate-700 font-black uppercase">{{ servicio.norma.codigo|default:"Sin Norma" }}</span>
                                </td>
                                <td class="py-5 px-6 border-y border-slate-50">
                                    {% if servicio.es_sujeto_a_presupuesto %}
                                    <span class="text-[10px] font-black text-amber-500 uppercase bg-amber-50 px-3 py-1 border border-amber-100">Cotizar</span>
                                    {% else %}
                                    <span class="font-mono text-[12px] font-black">S/ {{ servicio.precio_base|floatformat:2 }}</span>
                                    {% endif %}
                                </td>
                                <td class="py-5 px-6 last:rounded-r-2xl border-y border-r border-slate-50 text-right">
                                    <div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-all transform translate-x-4 group-hover:translate-x-0">
                                        <a href="{% url 'servicios:editar_servicio' pk=servicio.pk %}" class="w-9 h-9 bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-blue-600 hover:text-white transition-all shadow-sm" style="clip-path: polygon(15% 0, 100% 0, 85% 100%, 0 100%);">
                                            <i data-lucide="pencil-line" class="w-4 h-4"></i>
                                        </a>
                                        <a href="{% url 'servicios:eliminar_servicio' pk=servicio.pk %}" class="w-9 h-9 bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-rose-600 hover:text-white transition-all shadow-sm" style="clip-path: polygon(15% 0, 100% 0, 85% 100%, 0 100%);">
                                            <i data-lucide="trash-2" class="w-4 h-4"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" class="py-20 text-center text-slate-400 uppercase text-xs">No hay registros</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                {% if servicios.has_other_pages %}
                <div id="pagination-controls" class="flex justify-between items-center mt-12 pt-6 border-t border-slate-100 px-2">
                    <p class="text-[9px] font-black text-slate-300 uppercase tracking-[0.3em] hidden sm:block">Vicaf Pro Engine v2.0</p>
                    <div class="flex items-center gap-6">
                        <span class="text-[10px] font-black text-slate-500 uppercase tracking-widest">Pág {{ servicios.number }} de {{ servicios.paginator.num_pages }}</span>
                        <div class="flex items-center gap-1">
                            {% if servicios.has_previous %}
                            <a href="?page={{ servicios.previous_page_number }}" class="w-10 h-10 flex items-center justify-center bg-slate-50 text-slate-400 hover:bg-slate-900 hover:text-white transition-all" style="clip-path: polygon(20% 0, 100% 0, 80% 100%, 0 100%);">
                                <i data-lucide="chevron-left" class="w-4 h-4"></i>
                            </a>
                            {% endif %}
                            
                            <div class="h-1.5 w-24 bg-slate-100 rounded-full overflow-hidden mx-2">
                                <div class="h-full bg-emerald-500 transition-all duration-500" style="width: {% widthratio servicios.number servicios.paginator.num_pages 100 %}%"></div>
                            </div>

                            {% if servicios.has_next %}
                            <a href="?page={{ servicios.next_page_number }}" class="w-10 h-10 flex items-center justify-center bg-slate-50 text-slate-400 hover:bg-slate-900 hover:text-white transition-all" style="clip-path: polygon(20% 0, 100% 0, 80% 100%, 0 100%);">
                                <i data-lucide="chevron-right" class="w-4 h-4"></i>
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div id="no-results-message" class="hidden text-center py-20">
    <p class="text-slate-400 text-xs font-black uppercase tracking-[0.3em]">Sin coincidencias para la búsqueda</p>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof lucide !== 'undefined') lucide.createIcons();

        const searchInput = document.getElementById('searchInput');
        const tableBody = document.getElementById('servicios-table-body');
        const pagination = document.getElementById('pagination-controls');
        const noResults = document.getElementById('no-results-message');

        searchInput.addEventListener('keyup', async (e) => {
            const query = e.target.value.trim();
            if (query.length > 2) {
                const url = `{% url 'servicios:buscar_servicios_api' %}?q=${query}`;
                try {
                    const response = await fetch(url);
                    const data = await response.json();
                    
                    tableBody.innerHTML = '';
                    if(pagination) pagination.classList.add('hidden');

                    if (data.length === 0) {
                        noResults.classList.remove('hidden');
                        tableBody.closest('.overflow-x-auto').classList.add('hidden');
                    } else {
                        noResults.classList.add('hidden');
                        tableBody.closest('.overflow-x-auto').classList.remove('hidden');
                        data.forEach(s => {
                            tableBody.innerHTML += `
                            <tr class="group bg-white hover:bg-slate-50 transition-all border-b border-slate-50">
                                <td class="py-5 px-6">
                                    <div class="flex items-center gap-4">
                                        <div class="w-10 h-10 bg-slate-900 flex items-center justify-center text-white font-bold text-[10px]" style="clip-path: polygon(20% 0, 100% 0, 80% 100%, 0 100%);">${s.codigo_facturacion || 'S'}</div>
                                        <div><p class="font-bold text-slate-800 text-[11px] uppercase">${s.nombre}</p></div>
                                    </div>
                                </td>
                                <td class="py-5 px-6"><span class="text-[10px] font-black uppercase">${s.norma_codigo || 'N/A'}</span></td>
                                <td class="py-5 px-6"><span class="font-mono text-[12px] font-black">S/ ${s.precio_base}</span></td>
                                <td class="py-5 px-6 text-right">
                                    <div class="flex justify-end gap-2"><a href="/servicios/editar/${s.pk}/" class="w-8 h-8 bg-slate-100 flex items-center justify-center"><i data-lucide="pencil-line" class="w-4 h-4"></i></a></div>
                                </td>
                            </tr>`;
                        });
                        lucide.createIcons();
                    }
                } catch (err) { console.error("Error:", err); }
            } else if (query.length === 0) {
                if (e.key === 'Backspace') window.location.reload();
            }
        });
    });
</script>
{% endblock %}