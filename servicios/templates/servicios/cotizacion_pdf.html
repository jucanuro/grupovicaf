{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Oferta Técnica-Económica N° {{ cotizacion.numero_oferta }}</title>
    <style>
        /* Mantenemos exactamente tus estilos originales */
       @page {
            size: A4;
            /* Aumentamos el margen superior para que la cabecera no tape el contenido */
            margin: 5cm 1.5cm 3cm 1.5cm; 

            @frame header_frame {
                -pdf-frame-content: header_content;
                top: 1cm;
                left: 1.5cm;
                width: 18cm;
                height: 4cm; /* Altura suficiente para el logo y la tabla */
            }

            @frame footer_frame {
                -pdf-frame-content: footer_content;
                bottom: 1cm;
                left: 1.5cm;
                width: 18cm;
                height: 1.5cm;
            }
        }
        
        /* Ajuste para que la tabla dentro de la cabecera no tenga bordes raros */
        #header_content table { border: none; margin-bottom: 0; }
        #header_content td { border: none; vertical-align: middle; }
        
        body { font-family: Helvetica, Arial, sans-serif; font-size: 9px; color: #000; line-height: 1.3; }
        .font-bold { font-weight: bold; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .corporate-blue { color: #004D99; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        td, th { vertical-align: top; }
        #header_content { font-size: 8px; text-align: right; color: #000; padding-bottom: 5px; }
        #footer_content { font-size: 9px; text-align: center; color: #000; padding-top: 5px; }
        .logo-img { width: 180px; height: auto; }
        .company-box { border: 1px solid #000; padding: 8px; font-size: 9px; }
        .offer-title-box { border: 1px solid #000; padding: 5px; margin: 10px 0; }
        .offer-title-text { font-weight: bold; font-size: 14px; color: #004D99; text-align: center; margin-bottom: 5px; }
        .client-table td { border: 1px solid #000; padding: 3px 5px; }
        .items-table th { background-color: #f0f0f0; border: 1px solid #000; text-align: center; font-weight: bold; font-size: 8px; padding: 4px; }
        .items-table td { border: 1px solid #000; padding: 4px; font-size: 9px; }
        .group-row { background-color: #e6f2ff; font-weight: bold; }
        .section-title { font-weight: bold; margin-top: 10px; margin-bottom: 5px; text-transform: uppercase; font-size: 10px; }
        .signature-box { margin-top: 30px; text-align: center; width: 230px; float: right; }
        .signature-line { border-top: 1px solid #000; margin-top: 5px; margin-bottom: 5px; }
        .signature-img-dynamic { height: 70px; margin-bottom: -10px; }
        .page-number:after { content: counter(page); }
        .page-count:after { content: counter(pages); }
    </style>
</head>
<body>

    <div id="header_content">
        <div style="text-align: right; font-size: 8px; margin-bottom: 5px;">
            Código: VCF-LAB-FOR-001 | Fecha: 2025-03-05 | Versión: 06 | Página <span class="page-number"></span> de <span class="page-count"></span>
        </div>
        
        <table>
            <tr>
                <td style="width: 45%; text-align: center;">
                    <img src="{% static 'img/LogoF.png' %}" class="logo-img" alt="Logo">
                </td>
                <td style="width: 55%;">
                    <div class="company-box" style="text-align: left;">
                        <strong>Razón Social:</strong> Grupo Vicaf SAC<br>
                        <strong>RUC:</strong> 20609464632<br>
                        <strong>Dirección:</strong> JR. LOS TOPACIOS 440 - CAJAMARCA<br>
                        <strong>Teléfono:</strong> 960 713 555 | <strong>Cel:</strong> +51 941 573 750<br>
                        <strong>Email:</strong> informes@grupovicaf.com
                    </div>
                </td>
            </tr>
        </table>
    </div>

    <div id="footer_content">
        <div style="border-top: 1px solid #000; width: 100%; margin-bottom: 5px;"></div>
        +51 941 573 750 | informes@grupovicaf.com <br>
        <strong>GRUPO VICAF SAC</strong>
    </div>

    <div class="offer-title-box">
        <div class="offer-title-text">OFERTA TÉCNICA - ECONÓMICA LABORATORIO</div>
        <table style="width: 100%; border: none; margin: 0;">
            <tr>
                <td style="border: none; font-weight: bold;">OFERTA No. {{ cotizacion.numero_oferta }}</td>
                <td style="border: none; text-align: right; font-weight: bold;">Fecha: {{ cotizacion.fecha_generacion|date:"d \d\e F \d\e Y" }}</td>
            </tr>
        </table>
    </div>

    <table class="client-table">
        <tr>
            <td style="width: 15%; background-color: #f0f0f0;"><strong>Señor(es):</strong></td>
            <td style="width: 45%;">{{ cotizacion.cliente.razon_social }}</td>
            <td style="width: 15%; background-color: #f0f0f0;"><strong>Servicio:</strong></td>
            <td style="width: 25%;">{{ cotizacion.asunto_servicio|default:"Ensayos de Laboratorio" }}</td>
        </tr>
    </table>

    <div class="section-title">1. OFERTA ECONÓMICA</div>
    <table class="items-table">
        <thead>
            <tr>
                <th style="width: 5%;">ÍTEM</th>
                <th style="width: 35%;">DESCRIPCIÓN</th>
                <th style="width: 18%;">NORMA / MÉTODO</th>
                <th style="width: 10%;">UND</th>
                <th style="width: 7%;">CANT</th>
                <th style="width: 11%;">P. UNIT</th>
                <th style="width: 14%;">PARCIAL</th>
            </tr>
        </thead>
        <tbody>
            {% for grupo in grupos %}
                <tr class="group-row">
                    <td class="text-center">
                        {% if forloop.counter == 1 %}A{% elif forloop.counter == 2 %}B{% elif forloop.counter == 3 %}C{% else %}{{ forloop.counter }}{% endif %}
                    </td>
                    <td colspan="6">{{ grupo.nombre_grupo }}</td>
                </tr>
                {% for detalle in grupo.detalles_items.all %}
                <tr>
                    <td class="text-center">{{ forloop.counter }}</td>
                    <td>
                        <strong>{{ detalle.servicio.nombre }}</strong>
                        {% if detalle.descripcion_especifica %}<br><span style="font-size: 8px;">{{ detalle.descripcion_especifica }}</span>{% endif %}
                    </td>
                    <td class="text-center">{{ detalle.servicio.norma|default:"-" }}</td>
                    <td class="text-center">
                        {# FIX DEFINITIVO PARA EL ERROR DE UNIDAD_MEDIDA #}
                        {% if detalle.unidad_medida %}{{ detalle.unidad_medida }}{% else %}Ensayo{% endif %}
                    </td>
                    <td class="text-center">{{ detalle.cantidad|floatformat:0 }}</td>
                    <td class="text-right">S/ {{ detalle.precio_unitario|floatformat:2 }}</td>
                    <td class="text-right">S/ {{ detalle.total_detalle|floatformat:2 }}</td>
                </tr>
                {% endfor %}
            {% endfor %}
        </tbody>
    </table>
    
    </body>
</html>