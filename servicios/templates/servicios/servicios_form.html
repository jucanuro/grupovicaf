{% extends "base_vicafpro.html" %}
{% load static %}

{% block content %}


<div class="bg-vicaf-engine"></div>

<div class="max-w-full mx-auto p-4 relative z-10 space-y-6">
    
    <header class="bg-white border border-slate-200 rounded-xl shadow-sm flex items-center justify-between p-4">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-md">
                <i data-lucide="{% if servicio %}edit-3{% else %}plus-circle{% endif %}" class="w-5 h-5"></i>
            </div>
            <div>
                <h1 class="text-xl font-extrabold text-slate-900 tracking-tight leading-none">
                    {% if servicio %}Edición de Servicio{% else %}Registro de Servicio / Ensayo{% endif %}
                </h1>
                <p class="text-[9px] font-mono-tech text-blue-600 mt-1 uppercase tracking-[0.2em]">Catálogo de Ingeniería // v2.6</p>
            </div>
        </div>

        <a href="{% url 'servicios:lista_servicios' %}" class="bg-white text-slate-700 border border-slate-200 px-4 py-2 rounded-lg text-xs font-bold hover:bg-slate-50 transition-all flex items-center gap-2 shadow-sm">
            <i data-lucide="arrow-left" class="w-3.5 h-3.5"></i> Volver
        </a>
    </header>

    <div class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden">
        <form method="post" class="p-8">
            {% csrf_token %}

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-10">
                
                <div class="space-y-5">
                    <div class="flex items-center gap-2 mb-2 border-b border-slate-100 pb-2">
                        <i data-lucide="tag" class="w-4 h-4 text-blue-500"></i>
                        <h3 class="text-[11px] font-black text-slate-400 uppercase tracking-widest">Identificación</h3>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Código Facturación</label>
                            <input type="text" name="codigo_facturacion" value="{{ servicio.codigo_facturacion|default:'' }}" 
                                class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-xs font-mono-tech font-semibold text-slate-700 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all" placeholder="Ej: M-001">
                        </div>
                        
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Nombre del Servicio</label>
                            <input type="text" name="nombre" value="{{ servicio.nombre|default:'' }}" 
                                class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-xs font-semibold text-slate-700 focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all" required>
                        </div>
                    </div>
                </div>

                <div class="space-y-5">
                    <div class="flex items-center gap-2 mb-2 border-b border-slate-100 pb-2">
                        <i data-lucide="file-text" class="w-4 h-4 text-blue-500"></i>
                        <h3 class="text-[11px] font-black text-slate-400 uppercase tracking-widest">Especificaciones Técnicas</h3>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Norma Técnica</label>
                            <div class="grid grid-cols-12 gap-2">
                                <div class="col-span-10">
                                    <select id="id_norma_select" name="norma" class="vicaf-search-select text-sm">
                                        <option class="text-sm" value="">SELECCIONAR NORMA...</option>
                                        {% for norma in normas_disponibles %}
                                        <option value="{{ norma.pk }}" {% if servicio.norma_id == norma.pk %}selected{% endif %}>{{ norma.codigo }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-span-2">
                                    <div onclick="openNormaModal()" 
                                        class="w-full h-[38px] cursor-pointer group relative flex items-center justify-center rounded-lg border border-blue-200 bg-gradient-to-br from-blue-50 to-white shadow-sm transition-all hover:border-blue-400 hover:shadow-md active:scale-95"
                                        title="Añadir nueva norma">
                                        <div class="absolute inset-0 bg-blue-500/0 group-hover:bg-blue-500/5 rounded-lg transition-colors"></div>
                                        <i data-lucide="plus-square" class="w-4 h-4 text-blue-600 group-hover:text-blue-700 transition-transform group-hover:scale-110"></i>
                                        <span class="absolute -top-1 -right-1 flex h-2 w-2">
                                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                                            <span class="relative inline-flex rounded-full h-2 w-2 bg-blue-600"></span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Método de Ensayo</label>
                            <div class="grid grid-cols-12 gap-2">
                                <div class="col-span-10">
                                    <select id="id_metodo_select" name="metodo" class="vicaf-search-select">
                                        <option value="">SELECCIONAR MÉTODO...</option>
                                        {% for metodo in metodos_disponibles %}
                                        <option value="{{ metodo.pk }}" {% if servicio.metodo_id == metodo.pk %}selected{% endif %}>{{ metodo.nombre }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-span-2">
                                    <div onclick="openMetodoModal()" 
                                        class="w-full h-[38px] cursor-pointer group relative flex items-center justify-center rounded-lg border border-blue-200 bg-gradient-to-br from-blue-50 to-white shadow-sm transition-all hover:border-blue-400 hover:shadow-md active:scale-95"
                                        title="Añadir nuevo método">
                                        <div class="absolute inset-0 bg-blue-500/0 group-hover:bg-blue-500/5 rounded-lg transition-colors"></div>
                                        <i data-lucide="beaker" class="w-4 h-4 text-blue-600 group-hover:text-blue-700 transition-transform group-hover:scale-110"></i>
                                        <span class="absolute -top-1 -right-1 flex h-2 w-2">
                                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                                            <span class="relative inline-flex rounded-full h-2 w-2 bg-blue-600"></span>
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div>
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Unidad de Medida</label>
                            <input type="text" name="unidad_base" value="{{ servicio.unidad_base|default:'ENSAYO' }}" 
                                class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-xs font-bold text-slate-700 uppercase focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 outline-none transition-all">
                        </div>
                    </div>
                </div>

                <div class="space-y-5">
                    <div class="flex items-center gap-2 mb-2 border-b border-slate-100 pb-2">
                        <i data-lucide="layers" class="w-4 h-4 text-blue-500"></i>
                        <h3 class="text-[11px] font-black text-slate-400 uppercase tracking-widest">Costos y Estado</h3>
                    </div>
                    
                    <div class="space-y-4">
                        <div class="group">
                            <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Precio Base (S/)</label>
                            <div class="relative flex items-center bg-blue-50/50 border border-blue-100 rounded-lg overflow-hidden transition-all">
                                <span class="pl-4 text-blue-600 font-black text-xs">S/</span>
                                <input type="number" step="0.01" name="precio_base" id="id_precio_base" value="{{ servicio.precio_base|default:'0.00' }}" 
                                    class="w-full py-2.5 px-3 bg-transparent font-extrabold text-blue-700 text-sm outline-none">
                            </div>
                        </div>

                        <div class="flex items-center justify-between p-3.5 bg-slate-50 border border-slate-200 rounded-xl">
                            <div class="flex items-center gap-2">
                                <i data-lucide="check-circle" class="w-3.5 h-3.5 text-emerald-500"></i>
                                <span class="text-[10px] font-bold text-slate-600 uppercase">Acreditado INACAL</span>
                            </div>
                            <input type="checkbox" name="esta_acreditado" class="w-4 h-4 accent-emerald-500 cursor-pointer" {% if servicio.esta_acreditado %}checked{% endif %}>
                        </div>

                        <div class="flex items-center justify-between p-3.5 bg-slate-50 border border-slate-200 rounded-xl">
                            <div class="flex items-center gap-2">
                                <i data-lucide="alert-triangle" class="w-3.5 h-3.5 text-amber-500"></i>
                                <span class="text-[10px] font-bold text-slate-600 uppercase">Sujeto a Presupuesto</span>
                            </div>
                            <input type="checkbox" name="es_sujeto_a_presupuesto" id="id_sp" class="w-4 h-4 accent-amber-500 cursor-pointer" {% if servicio.es_sujeto_a_presupuesto %}checked{% endif %}>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-10 pt-6 border-t border-slate-100 flex items-center justify-between">
                <div class="flex items-center gap-2">
                    <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                    <span class="text-[9px] font-mono-tech text-slate-400 uppercase tracking-widest italic">Actualización de Catálogo Segura</span>
                </div>
                
                <button type="submit" class="bg-slate-900 text-white px-10 py-3 rounded-xl text-xs font-bold hover:bg-blue-600 hover:-translate-y-1 shadow-lg transition-all flex items-center gap-3">
                    <i data-lucide="save" class="w-4 h-4"></i>
                    {% if servicio %}ACTUALIZAR SERVICIO{% else %}FINALIZAR REGISTRO{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>
<div id="modal-norma" class="fixed inset-0 z-[100] hidden items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm">
    <div class="bg-white border border-slate-200 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-200">
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-blue-100 text-blue-600 rounded-lg flex items-center justify-center">
                        <i data-lucide="book-open" class="w-5 h-5"></i>
                    </div>
                    <h3 class="text-sm font-bold text-slate-900 uppercase tracking-tight">Añadir Norma Técnica</h3>
                </div>
                <button type="button" onclick="closeNormaModal()" class="text-slate-400 hover:text-slate-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Código de Norma</label>
                    <input type="text" id="new_norma_codigo" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-xs font-mono-tech font-semibold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all" placeholder="Ej: ASTM C39 / NTP 339.034">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Nombre Completo</label>
                    <input type="text" id="new_norma_nombre" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-xs font-semibold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all" placeholder="Ej: Resistencia a la compresión...">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Descripción (Opcional)</label>
                    <textarea id="new_norma_desc" rows="2" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-xs font-semibold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all"></textarea>
                </div>
            </div>

            <div class="mt-8 flex items-center gap-3">
                <button type="button" onclick="closeNormaModal()" class="flex-1 px-4 py-2.5 rounded-lg text-xs font-bold text-slate-600 border border-slate-200 hover:bg-slate-50 transition-all">CANCELAR</button>
                <button type="button" onclick="saveNewNorma()" class="flex-1 px-4 py-2.5 rounded-lg text-xs font-bold text-white bg-blue-600 hover:bg-blue-700 shadow-md transition-all">GUARDAR NORMA</button>
            </div>
        </div>
    </div>
</div>

<div id="modal-metodo" class="fixed inset-0 z-[100] hidden items-center justify-center p-4 bg-slate-900/40 backdrop-blur-sm">
    <div class="bg-white border border-slate-200 w-full max-w-md rounded-2xl shadow-2xl overflow-hidden animate-in fade-in zoom-in duration-200">
        <div class="p-6">
            <div class="flex items-center justify-between mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-lg flex items-center justify-center">
                        <i data-lucide="beaker" class="w-5 h-5"></i>
                    </div>
                    <h3 class="text-sm font-bold text-slate-900 uppercase tracking-tight">Registrar Nuevo Método</h3>
                </div>
                <button type="button" onclick="closeMetodoModal()" class="text-slate-400 hover:text-slate-600">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Código del Método</label>
                    <input type="text" id="new_metodo_codigo" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-xs font-mono-tech font-semibold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all" placeholder="Ej: MET-SUELOS-01">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Nombre del Método</label>
                    <input type="text" id="new_metodo_nombre" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-xs font-semibold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all" placeholder="Ej: Método de ensayo estándar para...">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-slate-500 uppercase mb-1">Descripción Técnica (Opcional)</label>
                    <textarea id="new_metodo_desc" rows="2" class="w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-xs font-semibold text-slate-700 outline-none focus:ring-2 focus:ring-blue-500/20 focus:border-blue-500 transition-all"></textarea>
                </div>
            </div>

            <div class="mt-8 flex items-center gap-3">
                <button type="button" onclick="closeMetodoModal()" class="flex-1 px-4 py-2.5 rounded-lg text-xs font-bold text-slate-600 border border-slate-200 hover:bg-slate-50 transition-all">CANCELAR</button>
                <button type="button" onclick="saveNewMetodo()" class="flex-1 px-4 py-2.5 rounded-lg text-xs font-bold text-white bg-indigo-600 hover:bg-indigo-700 shadow-md transition-all">GUARDAR MÉTODO</button>
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block extra_scripts %}
<script>
    /**
     * GESTIÓN DE MODALES
     * Encapsulamos la apertura y cierre para mantener el código limpio
     */
    const UI = {
        normaModal: () => document.getElementById('modal-norma'),
        metodoModal: () => document.getElementById('modal-metodo'),
        
        openNorma: () => UI.normaModal().classList.replace('hidden', 'flex'),
        closeNorma: () => UI.normaModal().classList.replace('flex', 'hidden'),
        
        openMetodo: () => UI.metodoModal().classList.replace('hidden', 'flex'),
        closeMetodo: () => UI.metodoModal().classList.replace('flex', 'hidden')
    };

    // Alias para compatibilidad con tus onclick del HTML
    const openNormaModal = UI.openNorma;
    const closeNormaModal = UI.closeNorma;
    const openMetodoModal = UI.openMetodo;
    const closeMetodoModal = UI.closeMetodo;

    /**
     * PETICIONES ASÍNCRONAS (AJAX)
     */
    async function saveNewNorma() {
        const fields = {
            codigo: document.getElementById('new_norma_codigo'),
            nombre: document.getElementById('new_norma_nombre'),
            desc: document.getElementById('new_norma_desc')
        };
        
        if(!fields.codigo.value || !fields.nombre.value) return alert('Código y Nombre son obligatorios.');

        const formData = new FormData();
        formData.append('codigo_norma', fields.codigo.value);
        formData.append('nombre_norma', fields.nombre.value);
        formData.append('descripcion_norma', fields.desc.value);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        try {
            const response = await fetch("{% url 'servicios:crear_norma_ajax' %}", {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            
            if(data.success) {
                const select = document.getElementById('id_norma_select');
                updateSelect(select, data.id, data.codigo);
                
                UI.closeNorma();
                // Limpiar campos usando el objeto fields
                Object.values(fields).forEach(f => f.value = '');
            } else {
                alert("Error: " + data.error);
            }
        } catch (error) { console.error('Error:', error); }
    }

    async function saveNewMetodo() {
        const fields = {
            codigo: document.getElementById('new_metodo_codigo'),
            nombre: document.getElementById('new_metodo_nombre'),
            desc: document.getElementById('new_metodo_desc')
        };
        
        if(!fields.codigo.value || !fields.nombre.value) return alert('Código y Nombre son obligatorios.');

        const formData = new FormData();
        formData.append('codigo_metodo', fields.codigo.value);
        formData.append('nombre_metodo', fields.nombre.value);
        formData.append('descripcion_metodo', fields.desc.value);
        formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

        try {
            const response = await fetch("{% url 'servicios:crear_metodo_ajax' %}", {
                method: 'POST',
                body: formData
            });
            const data = await response.json();
            
            if(data.success) {
                const select = document.getElementById('id_metodo_select');
                const label = `${data.codigo} - ${data.nombre}`;
                updateSelect(select, data.id, label);
                
                UI.closeMetodo();
                Object.values(fields).forEach(f => f.value = '');
            } else {
                alert("Error: " + data.error);
            }
        } catch (error) { console.error('Error:', error); }
    }

    /**
     * FUNCIÓN AUXILIAR PARA ACTUALIZAR SELECTS (TomSelect o Nativo)
     */
    function updateSelect(el, id, text) {
        if (el.tomselect) {
            el.tomselect.addOption({value: id, text: text});
            el.tomselect.setValue(id);
        } else {
            const option = new Option(text, id, true, true);
            el.add(option);
        }
    }

    /**
     * INICIALIZACIÓN DEL DOM
     */
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Iconos Lucide
        if (typeof lucide !== 'undefined') lucide.createIcons();

        // 2. TomSelect
        document.querySelectorAll('.vicaf-search-select').forEach((el) => {
            new TomSelect(el, {
                create: false,
                onInitialize: function() {
                    this.wrapper.classList.add('vicaf-search');
                }
            });
        });

        // 3. Lógica Presupuesto (Mejorada para manejar el estado inicial)
        const spCheckbox = document.getElementById('id_sp');
        const precioInput = document.getElementById('id_precio_base');
        
        if (spCheckbox && precioInput) {
            const togglePrecio = () => {
                const container = precioInput.closest('.group');
                const isChecked = spCheckbox.checked;
                
                precioInput.disabled = isChecked;
                if (isChecked) precioInput.value = "0.00";
                
                container.style.opacity = isChecked ? "0.4" : "1";
                container.style.pointerEvents = isChecked ? "none" : "auto";
            };

            spCheckbox.addEventListener('change', togglePrecio);
            togglePrecio(); // Ejecutar al cargar para sincronizar
        }
    });
</script>
{% endblock %}