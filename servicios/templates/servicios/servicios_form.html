{% extends "base_vicafpro.html" %}
{% load static %}
{% block content %}

<style>
    /* * ELIMINACIÓN DE ESTILOS OSCUROS:
     * El 'input-elegant' y 'glass-card-main' se redefinen 
     * para usar colores blancos, grises claros y sombras sutiles.
     */
    .animated-gradient-text {
        background: linear-gradient(to right, #10B981, #3B82F6, #8B5CF6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-fill-color: transparent;
        background-size: 200% auto;
        animation: text-gradient 3s linear infinite alternate;
    }

    @keyframes text-gradient {
        to {
            background-position: 200% center;
        }
    }

    .input-elegant {
        transition: border-color 0.3s ease, box-shadow 0.3s ease;
        /* Fondo Blanco con borde y texto oscuro */
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08); /* Sombra sutil */
        border: 1px solid #d1d5db; /* Borde gris claro */
        background-color: #ffffff; /* Fondo blanco */
        color: #1f2937; /* Texto gris muy oscuro */
        padding: 0.75rem 1rem;
        border-radius: 0.75rem; 
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        /* Flecha del select en gris oscuro */
        background-position: right 1rem center;
        background-repeat: no-repeat;
        background-size: 1.5em 1.5em;
    }
    .input-elegant:focus {
        background-color: #ffffff;
        border-color: #3b82f6; /* Azul de enfoque */
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); /* Sombra azul de enfoque */
    }
    .glass-card-main {
        /* Se convierte en una tarjeta de fondo blanco con sombra pronunciada */
        background: #ffffff; 
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        border: 1px solid #f3f4f6; /* Borde muy claro */
    }
    /* ESTILOS DE LISTA DE SELECCIÓN DINÁMICA (Tags) */
    .dynamic-list-container {
        border: 1px solid #d1d5db; /* Borde claro */
        border-radius: 0.75rem;
        padding: 0.5rem;
        background-color: #f9fafb; /* Fondo gris muy claro */
        min-height: 100px;
    }
    .dynamic-tag {
        /* Mantenemos el azul de énfasis */
        display: inline-flex;
        align-items: center;
        margin: 0.25rem;
        padding: 0.3rem 0.6rem;
        border-radius: 0.5rem;
        background-color: #3b82f6; /* Azul de énfasis */
        color: white;
        font-size: 0.9rem;
        font-weight: 500;
    }
    .dynamic-tag .remove-btn {
        margin-left: 0.5rem;
        cursor: pointer;
        color: rgba(255, 255, 255, 0.8);
        transition: color 0.2s;
    }
    .dynamic-tag .remove-btn:hover {
        color: #fca5a5; /* Rojo claro al pasar el ratón */
    }
    /* Estilo para el input de tipo file, que debe ser de color oscuro en un tema claro */
    .input-file-custom {
        color: #1f2937 !important; /* Texto oscuro en el input file */
    }
</style>

<div class="space-y-6 min-h-screen p-6 md:p-6">
    <div class="border-b border-gray-200 pb-4 mb-6">
        <header class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 animate-fade-in-up">
            <h1 class="text-xl font-extrabold animated-gradient-text">
                {% if servicio %}Editar Servicio{% else %}Crear Nuevo Servicio{% endif %}
            </h1>
            <a href="{% url 'servicios:lista_servicios' %}" class="inline-flex items-center gap-2 py-2.5 px-6 bg-gray-100 text-gray-700 font-semibold rounded-xl shadow-md hover:bg-gray-200 transition-all duration-300 transform hover:scale-[1.02] border border-gray-300">
                <i data-lucide="list" class="w-5 h-5"></i>
                Regresar a la Lista
            </a>
        </header>
    </div>
    <div class="glass-card-main p-4 rounded-3xl shadow-xl animate-fade-in-up">
        {% if error %}
        <div class="bg-red-500/10 text-red-700 p-4 rounded-lg mb-6 border border-red-300">
            <p class="font-medium flex items-center gap-2"><i data-lucide="alert-triangle" class="w-5 h-5"></i> {{ error }}</p>
        </div>
        {% endif %}

        <form method="post" class="space-y-6" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="space-y-6">
                <h2 class="text-xl font-bold text-gray-800 border-b-2 border-gray-200 pb-3">
                    <i data-lucide="info" class="inline-block w-5 h-5 mr-2 text-blue-500"></i>
                    Información Básica
                </h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-8 items-start">
                    
                    <div class="lg:col-span-3 space-y-6">
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <div>
                                <label for="id_nombre" class="block text-sm font-medium text-gray-700">Nombre del Servicio</label>
                                <input type="text" id="id_nombre" name="nombre" value="{{ servicio.nombre|default:'' }}" 
                                        class="mt-2 block w-full input-elegant" required>
                            </div>
                            <div>
                                <label for="id_codigo_facturacion" class="block text-sm font-medium text-gray-700">Código de Facturación</label>
                                <input type="text" id="id_codigo_facturacion" name="codigo_facturacion" value="{{ servicio.codigo_facturacion|default:'' }}" 
                                        class="mt-2 block w-full input-elegant" required>
                            </div>
                            <div>
                                <label for="id_categoria" class="block text-sm font-medium text-gray-700">Categoría</label>
                                <select id="id_categoria" name="categoria" class="mt-2 block w-full input-elegant">
                                    <option value="">--- Sin Categoría ---</option>
                                    {% for categoria in categorias_disponibles %}
                                        <option value="{{ categoria.pk }}" {% if servicio.categoria_id == categoria.pk %}selected{% endif %}>
                                            {{ categoria.nombre }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        
                        <div>
                            <label for="id_descripcion" class="block text-sm font-medium text-gray-700">Descripción General (Resumen)</label>
                            <textarea id="id_descripcion" name="descripcion" rows="4"
                                    class="mt-2 block w-full input-elegant" required>{{ servicio.descripcion|default:'' }}</textarea>
                        </div>

                    </div>

                    <div class="lg:col-span-1 space-y-6 p-6 bg-gray-50 rounded-xl border border-gray-200 shadow-inner">
                        <h3 class="text-lg font-semibold text-gray-700">Media Principal</h3>
                        <div>
                            <label for="id_imagen" class="block text-sm font-medium text-gray-700">Imagen Representativa</label>
                            <input type="file" id="id_imagen" name="imagen" class="mt-2 block w-full input-elegant input-file-custom">
                            {% if servicio.imagen %}
                            <p class="mt-2 text-sm text-gray-500">Actual: <a href="{{ servicio.imagen.url }}" target="_blank" class="text-blue-600 hover:underline flex items-center gap-1">Ver Imagen <i data-lucide="external-link" class="w-3 h-3"></i></a></p>
                            {% endif %}
                        </div>
                    </div>

                </div>
            </div>

            <div class="space-y-6">
                <h2 class="text-xl font-bold text-gray-800 border-b-2 border-gray-200 pb-3">
                    <i data-lucide="dollar-sign" class="inline-block w-5 h-5 mr-2 text-green-600"></i>
                    Tarifario y Unidades
                </h2>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 p-6 bg-gray-50 rounded-xl border border-gray-200 shadow-inner">
                    
                    <div>
                        <label for="id_precio_base" class="block text-sm font-medium text-gray-700">Precio Base (S/)</label>
                        <input type="number" step="0.01" id="id_precio_base" name="precio_base" value="{{ servicio.precio_base|default:'0.00' }}" 
                                class="mt-2 block w-full input-elegant" required>
                    </div>

                    <div>
                        <label for="id_precio_urgente" class="block text-sm font-medium text-gray-700">Precio Urgente (S/)</label>
                        <input type="number" step="0.01" id="id_precio_urgente" name="precio_urgente" value="{{ servicio.precio_urgente|default:'' }}" 
                                class="mt-2 block w-full input-elegant" placeholder="Opcional">
                    </div>

                    <div>
                        <label for="id_unidad_base" class="block text-sm font-medium text-gray-700">Unidad Base</label>
                        <input type="text" id="id_unidad_base" name="unidad_base" value="{{ servicio.unidad_base|default:'Ensayo' }}" 
                                class="mt-2 block w-full input-elegant" placeholder="Ej: Ensayo, punto, metro">
                    </div>
                    
                    <div class="flex flex-col justify-center space-y-3 pt-2">
                        <div class="flex items-center">
                            <input id="id_esta_acreditado" name="esta_acreditado" type="checkbox" 
                                    {% if servicio.esta_acreditado %}checked{% endif %}
                                    class="w-5 h-5 text-blue-600 bg-white border-gray-300 rounded focus:ring-blue-500">
                            <label for="id_esta_acreditado" class="ml-2 text-sm font-medium text-gray-700">¿Acreditado?</label>
                            <i data-lucide="check-circle" class="w-4 h-4 ml-1 text-blue-600"></i>
                        </div>
                        <div class="flex items-center">
                            <input id="id_es_sujeto_a_presupuesto" name="es_sujeto_a_presupuesto" type="checkbox" 
                                    {% if servicio.es_sujeto_a_presupuesto %}checked{% endif %}
                                    class="w-5 h-5 text-indigo-600 bg-white border-gray-300 rounded focus:ring-indigo-500">
                            <label for="id_es_sujeto_a_presupuesto" class="ml-2 text-sm font-medium text-gray-700">Sujeto a Presupuesto (SP)</label>
                            <i data-lucide="alert-triangle" class="w-4 h-4 ml-1 text-indigo-600" title="Anula los precios si está marcado."></i>
                        </div>
                    </div>

                </div>
            </div>

            <div class="space-y-6">
                <h2 class="text-xl font-bold text-gray-800 border-b-2 border-gray-200 pb-3">
                    <i data-lucide="tag" class="inline-block w-5 h-5 mr-2 text-cyan-600"></i>
                    Regulaciones Técnicas (Normas y Métodos)
                </h2>
                <p class="text-sm text-gray-500 -mt-4 mb-6">Busque el código de la Norma/Método. La selección se guarda al elegir una opción del listado.</p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div class="space-y-3">
                        <label for="input_normas" class="font-bold text-gray-700 block mb-2 text-lg flex items-center gap-2">
                            <i data-lucide="award" class="w-5 h-5 text-cyan-600"></i> Normas Aplicables
                        </label>
                        
                        <div class="flex gap-2">
                            <input type="text" id="input_normas" placeholder="Buscar Código/Nombre..." list="data_normas"
                                class="block w-full input-elegant flex-grow">
                            </div>

                        <datalist id="data_normas">
                            {% for norma in normas_disponibles %}
                                <option value="{{ norma.codigo }} - {{ norma.nombre }}" data-id="{{ norma.pk }}"></option>
                            {% endfor %}
                        </datalist>

                        <div id="selected_normas_display" class="dynamic-list-container">
                            {% for norma in servicio.normas.all %}
                                <span class="dynamic-tag" data-id="{{ norma.pk }}">
                                    {{ norma.codigo }} - {{ norma.nombre }}
                                    <i data-lucide="x" class="remove-btn w-3 h-3 ml-2"></i>
                                </span>
                            {% endfor %}
                        </div>

                        <select name="normas" id="id_normas" multiple class="hidden">
                            {% for norma in servicio.normas.all %}
                                <option value="{{ norma.pk }}" selected>{{ norma.codigo }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="space-y-3">
                        <label for="input_metodos" class="font-bold text-gray-700 block mb-2 text-lg flex items-center gap-2">
                            <i data-lucide="microscope" class="w-5 h-5 text-cyan-600"></i> Métodos de Ensayo/Ejecución
                        </label>
                        
                            <div class="flex gap-2">
                            <input type="text" id="input_metodos" placeholder="Buscar Código/Nombre..." list="data_metodos"
                                class="block w-full input-elegant flex-grow">
                            </div>

                        <datalist id="data_metodos">
                            {% for metodo in metodos_disponibles %}
                                <option value="{{ metodo.codigo }} - {{ metodo.nombre }}" data-id="{{ metodo.pk }}"></option>
                            {% endfor %}
                        </datalist>

                        <div id="selected_metodos_display" class="dynamic-list-container">
                            {% for metodo in servicio.metodos.all %}
                                    <span class="dynamic-tag" data-id="{{ metodo.pk }}">
                                        {{ metodo.codigo }} - {{ metodo.nombre }}
                                        <i data-lucide="x" class="remove-btn w-3 h-3 ml-2"></i>
                                    </span>
                                {% endfor %}
                        </div>

                        <select name="metodos" id="id_metodos" multiple class="hidden">
                            {% for metodo in servicio.metodos.all %}
                                <option value="{{ metodo.pk }}" selected>{{ metodo.codigo }}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
            </div>

            <div class="space-y-6 pt-8">
                <h2 class="text-xl font-bold text-gray-800 border-b-2 border-gray-200 pb-3">
                    <i data-lucide="hard-hat" class="inline-block w-5 h-5 mr-2 text-indigo-600"></i>
                    Alcance Técnico y Detalle Web (Página Pública)
                </h2>
                <p class="mt-2 text-sm text-gray-500 -mt-4 mb-6">
                    Esta información es para la visualización ampliada del servicio en la página web pública.
                </p>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 p-6 rounded-xl bg-gray-50 border border-gray-200 shadow-inner">
                    
                    <div>
                        <label for="id_detalle_titulo" class="block text-sm font-medium text-gray-700">Título del Detalle</label>
                        <input type="text" id="id_detalle_titulo" name="detalle_titulo" value="{{ detalle_servicio.titulo|default:'' }}" 
                                class="mt-2 block w-full input-elegant">
                    </div>

                    <div class="md:col-span-2">
                        <label for="id_detalle_descripcion" class="block text-sm font-medium text-gray-700">Descripción del Detalle (Puntos Clave)</label>
                        <textarea id="id_detalle_descripcion" name="detalle_descripcion" rows="4"
                                    class="mt-2 block w-full input-elegant">{{ detalle_servicio.descripcion|default:'' }}</textarea>
                    </div>
                    
                    <div class="md:col-span-3">
                        <label for="id_detalle_imagen" class="block text-sm font-medium text-gray-700">Imagen del Detalle (Opcional)</label>
                        <input type="file" id="id_detalle_imagen" name="detalle_imagen" class="mt-2 block w-full input-elegant input-file-custom">
                        {% if detalle_servicio.imagen %}
                        <p class="mt-2 text-sm text-gray-500">Imagen actual: <a href="{{ detalle_servicio.imagen.url }}" target="_blank" class="text-blue-600 hover:underline flex items-center gap-1">Ver Imagen <i data-lucide="external-link" class="w-3 h-3"></i></a></p>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <div class="flex justify-end pt-8">
                <button type="submit" class="inline-flex items-center gap-2 px-10 py-3.5 border border-transparent shadow-xl text-base font-bold rounded-full text-white bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 focus:outline-none focus:ring-4 focus:ring-offset-2 focus:ring-blue-500 focus:ring-offset-white transition-all duration-300 transform hover:scale-[1.02]">
                    <i data-lucide="save" class="w-6 h-6"></i>
                    {% if servicio %}ACTUALIZAR SERVICIO{% else %}CREAR SERVICIO{% endif %}
                </button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        /**
         * Función genérica para manejar la lógica de agregar/eliminar items.
         * @param {string} type - 'normas' o 'metodos'
         */
        function setupDynamicSelector(type) {
            const inputElement = document.getElementById(`input_${type}`);
            const datalistElement = document.getElementById(`data_${type}`);
            const displayContainer = document.getElementById(`selected_${type}_display`);
            const hiddenSelect = document.getElementById(`id_${type}`);
            
            if (!inputElement) {
                console.error(`[ERROR ROBUSTO] Faltan elementos clave (input_${type}) para el selector dinámico de: ${type}.`);
                return; 
            }

            displayContainer.querySelectorAll('.dynamic-tag .remove-btn').forEach(btn => {
                // Asegurar que el ícono de Lucide exista y el evento de click esté activo
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons({
                        icons: { x: lucide.icons.x },
                        container: btn.closest('.dynamic-tag')
                    });
                }
                btn.onclick = (e) => removeTag(e.target.closest('.dynamic-tag'));
            });

            const addTagFromDatalist = (inputValue) => {
                if (!inputValue) return;

                let itemId = null;
                let itemText = inputValue;

                // Buscar el ID en el Datalist
                const options = Array.from(datalistElement.options);
                const match = options.find(opt => opt.value === inputValue);

                if (!match) {
                    // Si no hay match exacto, no hacemos nada (evitamos crear nuevos ítems)
                    return; 
                }
                
                itemId = match.getAttribute('data-id');

                // 3. Verificar si ya existe (por ID)
                if (hiddenSelect.querySelector(`option[value="${itemId}"]`)) {
                    return; // Ya existe
                }

                // 4. Crear el Tag visual
                const tag = document.createElement('span');
                tag.className = 'dynamic-tag';
                tag.setAttribute('data-id', itemId);
                tag.innerHTML = `${itemText} <i data-lucide="x" class="remove-btn w-3 h-3 ml-2"></i>`;
                displayContainer.appendChild(tag);
                
                // Inicializar el ícono de Lucide para el nuevo tag
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons({
                        icons: { x: lucide.icons.x },
                        container: tag
                    });
                }
                
                tag.querySelector('.remove-btn').onclick = (e) => removeTag(e.target.closest('.dynamic-tag'));

                // 5. Agregar la opción al Select Oculto (para Django)
                const option = document.createElement('option');
                option.value = itemId;
                option.text = itemId; 
                option.selected = true; // Importante para que se envíe en el POST
                hiddenSelect.appendChild(option);

                // Limpiar el input
                inputElement.value = '';
            };

            // 6. Función para eliminar un Tag
            const removeTag = (tagElement) => {
                const itemId = tagElement.getAttribute('data-id');
                
                // Eliminar del Select Oculto
                const optionToRemove = hiddenSelect.querySelector(`option[value="${itemId}"]`);
                if (optionToRemove) {
                    hiddenSelect.removeChild(optionToRemove);
                }

                // Eliminar el Tag visual
                tagElement.remove();
            };

            // 7. Evento clave: Cuando el valor cambia y es una opción válida (se selecciona del datalist)
            inputElement.addEventListener('input', (e) => {
                 // El evento 'input' se dispara en cada tecla. 
                 // Revisamos si el valor actual coincide con alguna opción del datalist.
                const inputValue = e.target.value.trim();
                const options = Array.from(datalistElement.options);
                const match = options.find(opt => opt.value === inputValue);
                
                if (match) {
                    addTagFromDatalist(inputValue);
                }
            });

            // Opcional: limpiar el input si no se seleccionó nada al salir del campo
             inputElement.addEventListener('blur', (e) => {
                e.target.value = '';
            });
        }

        // Inicializar selectores
        setupDynamicSelector('normas');
        setupDynamicSelector('metodos');
    });
</script>
{% endblock %}