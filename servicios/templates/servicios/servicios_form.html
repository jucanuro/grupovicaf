{% extends "base_vicafpro.html" %}
{% load static %}
{% block content %}

<style>
    /* Estilos Base Vicaf Pro */
    .bg-geometric {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        z-index: -1; background-color: #ffffff; overflow: hidden;
    }

    .shape-rhombus {
        position: absolute; width: 150px; height: 150px;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(37, 99, 235, 0.02) 100%);
        transform: rotate(45deg); border-radius: 20px; top: 10%; left: -50px;
        animation: float 6s ease-in-out infinite;
    }

    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(45deg); }
        50% { transform: translateY(-20px) rotate(48deg); }
    }

    .animated-gradient-text {
        background: linear-gradient(to right, #10B981, #3B82F6, #8B5CF6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-size: 200% auto;
        animation: text-gradient 3s linear infinite alternate;
    }

    @keyframes text-gradient { to { background-position: 200% center; } }

    .glass-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.7);
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.04);
    }

    .input-trapezoid {
        clip-path: polygon(4% 0%, 100% 0%, 96% 100%, 0% 100%);
        transition: all 0.3s ease;
    }

    /* --- AJUSTES PARA BUSCADOR TOM SELECT (LETRA PEQUEÑA) --- */
    .ts-wrapper.vicaf-search .ts-control {
        clip-path: polygon(5% 0, 100% 0, 95% 100%, 0 100%);
        border: 1px solid #cbd5e1;
        padding: 6px 20px !important; /* Padding reducido */
        font-size: 10px !important;    /* Letra más pequeña */
        font-weight: 800;
        text-transform: uppercase;
        background-color: white;
        min-height: 38px !important;   /* Más compacto verticalmente */
        display: flex;
        align-items: center;
    }
    
    .ts-wrapper.vicaf-search.focus .ts-control {
        border-color: #2563eb;
        box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.1);
    }

    /* Letra del input cuando escribes */
    .ts-wrapper.vicaf-search .ts-control input {
        font-size: 10px !important;
    }

    /* Estilo del menú desplegable */
    .ts-wrapper.vicaf-search .ts-dropdown {
        font-size: 9px !important;     /* Letra de las opciones */
        font-weight: 700;
        border-radius: 0;
        clip-path: polygon(0 0, 100% 0, 98% 100%, 2% 100%);
        border-color: #cbd5e1;
        margin-top: 4px;
    }

    .ts-dropdown .option {
        padding: 8px 15px !important;
        text-transform: uppercase;
    }

    .ts-dropdown .active {
        background-color: #eff6ff !important;
        color: #1e40af !important;
    }

    /* Estilo de la etiqueta del item seleccionado */
    .ts-wrapper.vicaf-search .ts-control .item {
        font-size: 10px !important;
        color: #1e40af;
    }
</style>

<div class="bg-geometric">
    <div class="shape-rhombus"></div>
    <div class="shape-rhombus" style="top: 70%; left: 80%; width: 80px; height: 80px; opacity: 0.5;"></div>
</div>

<div class="space-y-6 relative z-10">
    <div class="pb-8 mb-4">
        <header class="flex flex-col lg:flex-row items-start lg:items-center justify-between gap-6">
            <div class="relative pl-4 border-l-4 border-blue-600">
                <h1 class="text-xl font-black tracking-tighter animated-gradient-text uppercase">
                    {% if servicio %}Editar Servicio{% else %}Nuevo Registro de Servicio{% endif %}
                </h1>
                <p class="text-slate-500 text-xs font-bold mt-1 uppercase tracking-[0.2em] flex items-center gap-2">
                    <span class="w-8 h-[1px] bg-slate-300"></span>
                    Catálogo Maestro de Ingeniería
                </p>
            </div>
            
            <a href="{% url 'servicios:lista_servicios' %}" 
               class="relative inline-flex items-center gap-3 px-8 py-3 bg-slate-900 text-white transition-all duration-300 hover:bg-blue-600 hover:-translate-y-1 group"
               style="clip-path: polygon(15% 0, 100% 0, 85% 100%, 0 100%);">
                <i data-lucide="arrow-left" class="w-4 h-4 group-hover:-translate-x-1 transition-transform"></i>
                <span class="text-xs font-black uppercase tracking-[0.2em]">Volver</span>
            </a>
        </header>
    </div>

    <div class="relative group/container">
        <div class="absolute inset-0 bg-slate-200/60 translate-y-3 translate-x-1 -z-10" 
            style="clip-path: polygon(0 0, 100% 0, 98% 100%, 2% 100%);"></div>

        <div class="glass-card p-1 overflow-hidden" 
            style="clip-path: polygon(0 0, 100% 0, 98% 100%, 2% 100%); border-radius: 4px;">
            
            <form method="post" class="bg-white/95 backdrop-blur-2xl p-6 md:p-12 space-y-8">
                {% csrf_token %}

                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div class="md:col-span-1">
                        <label class="block text-[10px] font-black text-slate-400 uppercase tracking-[0.25em] mb-3 px-4">Código Facturación</label>
                        <div class="relative group">
                            <div class="absolute inset-0 bg-slate-100 translate-y-1 translate-x-1 -z-10" style="clip-path: polygon(5% 0, 100% 0, 95% 100%, 0 100%);"></div>
                            <input type="text" name="codigo_facturacion" value="{{ servicio.codigo_facturacion|default:'' }}" 
                                   class="w-full bg-white border border-slate-300 py-3 px-6 input-trapezoid font-mono text-sm focus:ring-2 focus:ring-blue-600 outline-none uppercase" placeholder="M-000">
                        </div>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-[10px] font-black text-slate-400 uppercase tracking-[0.25em] mb-3 px-4">Nombre del Servicio / Ensayo</label>
                        <div class="relative group">
                            <div class="absolute inset-0 bg-slate-100 translate-y-1 translate-x-1 -z-10" style="clip-path: polygon(3% 0, 100% 0, 97% 100%, 0 100%);"></div>
                            <input type="text" name="nombre" value="{{ servicio.nombre|default:'' }}" 
                                   class="w-full bg-white border border-slate-300 py-3 px-8 input-trapezoid font-black text-sm uppercase focus:ring-2 focus:ring-blue-600 outline-none" required>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase tracking-[0.25em] mb-3 px-4">Norma Técnica</label>
                        <div class="relative">
                            <div class="absolute inset-0 bg-slate-100 translate-y-1 translate-x-1 -z-10" style="clip-path: polygon(5% 0, 100% 0, 95% 100%, 0 100%);"></div>
                            <select name="norma" class="vicaf-search-select text-xs" placeholder="BUSCAR NORMA...">
                                <option value="">SELECCIONAR NORMA</option>
                                {% for norma in normas_disponibles %}
                                <option value="{{ norma.pk }}" {% if servicio.norma_id == norma.pk %}selected{% endif %}>{{ norma.codigo }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase tracking-[0.25em] mb-3 px-4">Método de Ensayo</label>
                        <div class="relative">
                            <div class="absolute inset-0 bg-slate-100 translate-y-1 translate-x-1 -z-10" style="clip-path: polygon(5% 0, 100% 0, 95% 100%, 0 100%);"></div>
                            <select name="metodo" class="vicaf-search-select" placeholder="BUSCAR MÉTODO...">
                                <option value="">SELECCIONAR MÉTODO</option>
                                {% for metodo in metodos_disponibles %}
                                <option value="{{ metodo.pk }}" {% if servicio.metodo_id == metodo.pk %}selected{% endif %}>{{ metodo.nombre }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-[10px] font-black text-slate-400 uppercase tracking-[0.25em] mb-3 px-4">Unidad Medida</label>
                        <div class="relative group">
                            <div class="absolute inset-0 bg-slate-100 translate-y-1 translate-x-1 -z-10" style="clip-path: polygon(5% 0, 100% 0, 95% 100%, 0 100%);"></div>
                            <input type="text" name="unidad_base" value="{{ servicio.unidad_base|default:'ENSAYO' }}" 
                                   class="w-full bg-white border border-slate-300 py-3 px-6 input-trapezoid text-[11px] font-black uppercase outline-none focus:ring-2 focus:ring-blue-600">
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 items-end">
                    <div class="relative">
                        <label class="block text-[10px] font-black text-slate-400 uppercase tracking-[0.25em] mb-3 px-4">Precio Base (S/)</label>
                        <div class="relative group">
                            <div class="absolute inset-0 bg-blue-50 translate-y-1 translate-x-1 -z-10" style="clip-path: polygon(5% 0, 100% 0, 95% 100%, 0 100%);"></div>
                            <div class="relative flex items-center bg-white border border-blue-200 input-trapezoid overflow-hidden">
                                <span class="pl-6 text-blue-600 font-black text-xs">S/</span>
                                <input type="number" step="0.01" name="precio_base" id="id_precio_base" value="{{ servicio.precio_base|default:'0.00' }}" 
                                       class="w-full py-4 px-4 bg-transparent font-black text-blue-600 text-lg outline-none">
                            </div>
                        </div>
                    </div>

                    <div class="relative h-[56px] flex items-center justify-between px-8 bg-slate-50 border border-slate-200" style="clip-path: polygon(5% 0, 100% 0, 95% 100%, 0 100%);">
                        <span class="text-[10px] font-black text-slate-600 uppercase tracking-tighter">Acreditado INACAL</span>
                        <input type="checkbox" name="esta_acreditado" class="w-5 h-5 accent-emerald-500" {% if servicio.esta_acreditado %}checked{% endif %}>
                    </div>

                    <div class="relative h-[56px] flex items-center justify-between px-8 bg-slate-50 border border-slate-200" style="clip-path: polygon(5% 0, 100% 0, 95% 100%, 0 100%);">
                        <span class="text-[10px] font-black text-slate-600 uppercase tracking-tighter">Sujeto a Presupuesto</span>
                        <input type="checkbox" name="es_sujeto_a_presupuesto" id="id_sp" class="w-5 h-5 accent-amber-500" {% if servicio.es_sujeto_a_presupuesto %}checked{% endif %}>
                    </div>
                </div>

                <div class="pt-10 flex flex-col items-end">
                    <button type="submit" 
                            class="relative min-w-[320px] px-10 py-5 bg-blue-600 text-white transition-all duration-300 hover:bg-emerald-500 hover:-translate-y-1 group shadow-lg shadow-blue-900/20"
                            style="clip-path: polygon(10% 0, 100% 0, 90% 100%, 0 100%);">
                        
                        <div class="flex items-center justify-center gap-4">
                            <i data-lucide="save" class="w-5 h-5 group-hover:rotate-12 transition-transform"></i>
                            <span class="text-xs font-black uppercase tracking-[0.3em]">
                                Finalizar Registro
                            </span>
                        </div>
                        <div class="absolute inset-0 bg-white/10 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                    </button>
                    <p class="text-[9px] font-bold text-slate-300 uppercase mt-4 tracking-[0.5em] mr-6">
                        Sistema de Gestión Vicaf Pro v2.0
                    </p>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Iconos Lucide
        if (typeof lucide !== 'undefined') lucide.createIcons();

        // 2. Inicializar Buscadores Tom Select
        document.querySelectorAll('.vicaf-search-select').forEach((el) => {
            new TomSelect(el, {
                create: false,
                controlInput: '<input />',
                render: {
                    option: function(data, escape) {
                        return '<div class="py-2 px-4 border-b border-slate-50 text-xs"><strong>' + escape(data.text) + '</strong></div>';
                    }
                },
                onInitialize: function() {
                    this.wrapper.classList.add('vicaf-search');
                }
            });
        });

        // 3. Lógica de Precio vs Sujeto a Presupuesto
        const spCheckbox = document.getElementById('id_sp');
        const precioInput = document.getElementById('id_precio_base');

        const togglePrecio = () => {
            if (spCheckbox.checked) {
                precioInput.disabled = true;
                precioInput.value = "0.00";
                precioInput.closest('.group').style.opacity = "0.4";
            } else {
                precioInput.disabled = false;
                precioInput.closest('.group').style.opacity = "1";
            }
        };

        spCheckbox.addEventListener('change', togglePrecio);
        togglePrecio();
    });
</script>
{% endblock %}