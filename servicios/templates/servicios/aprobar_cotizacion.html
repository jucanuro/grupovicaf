{% extends "base_vicafpro.html" %}
{% load static %}

{% block content %}
<style>
    /* ✅ FONDO GEOMÉTRICO VICAF PRO */
    .bg-geometric {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        z-index: -1; background-color: #ffffff; overflow: hidden;
    }
    .shape-rhombus {
        position: absolute; width: 150px; height: 150px;
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.05) 0%, rgba(37, 99, 235, 0.02) 100%);
        transform: rotate(45deg); border-radius: 20px; top: 10%; left: -50px;
        animation: float 6s ease-in-out infinite;
    }
    @keyframes float {
        0%, 100% { transform: translateY(0px) rotate(45deg); }
        50% { transform: translateY(-20px) rotate(48deg); }
    }

    .animated-gradient-text {
        background: linear-gradient(to right, #3B82F6, #10B981);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-size: 200% auto;
        animation: text-gradient 3s linear infinite alternate;
    }

    .glass-card {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.7);
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.04);
    }

    /* ✅ INPUTS CORREGIDOS: pl-12 para alejar el texto del borde izquierdo */
    .input-vicaf {
        @apply w-full pl-12 pr-6 py-3 bg-slate-50 border border-slate-200 text-slate-700 text-[11px] font-bold uppercase tracking-wider transition-all;
        clip-path: polygon(3% 0%, 100% 0%, 97% 100%, 0% 100%);
    }
    .input-vicaf:focus {
        @apply bg-white border-blue-500 ring-0 outline-none shadow-inner;
        clip-path: polygon(0% 0%, 97% 0%, 100% 100%, 3% 100%);
    }

    /* ✅ FILE INPUTS CORREGIDOS: Espaciado interno para el texto del archivo */
    .file-vicaf {
        @apply block w-full text-[10px] text-slate-500 font-bold uppercase border border-slate-100 bg-slate-50/50 cursor-pointer;
        clip-path: polygon(3% 0%, 100% 0%, 97% 100%, 0% 100%);
        padding-right: 15px; /* Evita que el nombre del archivo toque el borde derecho */
    }
    
    .file-vicaf::file-selector-button {
        @apply mr-6 py-3 px-8 border-0 text-[10px] font-black uppercase tracking-widest bg-slate-900 text-white transition-colors cursor-pointer;
        clip-path: polygon(0 0, 100% 0, 80% 100%, 0 100%);
    }
    .file-vicaf:hover::file-selector-button { @apply bg-blue-600; }
</style>

<div class="bg-geometric">
    <div class="shape-rhombus"></div>
</div>

<div class="max-w-full mx-auto space-y-4 relative z-10 p-2 md:p-4 -mt-4">
    
    <header class="flex flex-col md:flex-row items-start md:items-center justify-between gap-4 animate-fade-in-up">
        <div class="relative pl-4 border-l-4 border-blue-600">
            <h1 class="text-xl font-black tracking-tighter animated-gradient-text uppercase">Aprobación y Cierre</h1>
            <p class="text-slate-500 text-[10px] font-bold mt-0.5 uppercase tracking-[0.2em] flex items-center gap-2">
                <span class="w-8 h-[1px] bg-slate-300"></span> Creación Automática de Proyecto
            </p>
        </div>
        <a href="{% url 'servicios:lista_cotizaciones' %}" class="relative inline-flex items-center gap-4 px-8 py-2.5 bg-slate-100 text-slate-600 transition-all hover:bg-slate-900 hover:text-white group" style="clip-path: polygon(8% 0, 100% 0, 92% 100%, 0 100%);">
            <i data-lucide="list" class="w-4 h-4"></i>
            <span class="text-[10px] font-black uppercase tracking-widest">Lista de Cotizaciones</span>
        </a>
    </header>

    <div class="relative animate-fade-in-up">
        <div class="absolute inset-0 bg-slate-200/60 translate-y-2 translate-x-1 -z-10" style="clip-path: polygon(0 0, 100% 0, 99% 100%, 1% 100%);"></div>
        
        <div class="glass-card p-0.5" style="clip-path: polygon(0 0, 100% 0, 99% 100%, 1% 100%); border-radius: 4px;">
            <div class="bg-white/95 backdrop-blur-2xl p-6 md:p-10"> <div class="flex flex-wrap items-center gap-10 pb-6 mb-8 border-b border-slate-100">
                    <div>
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1.5">N° de Cotización</p>
                        <span class="px-4 py-1.5 bg-slate-900 text-white font-black text-xs tracking-tighter" style="clip-path: polygon(8% 0, 100% 0, 92% 100%, 0 100%);">
                            {{ cotizacion.numero_oferta }}
                        </span>
                    </div>
                    <div>
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1.5">Razón Social Cliente</p>
                        <p class="font-black text-slate-800 text-[13px] uppercase tracking-tighter">{{ cotizacion.cliente.razon_social }}</p>
                    </div>
                    <div>
                        <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1.5">Total a Validar</p>
                        <p class="font-mono text-lg font-black text-blue-600">S/ {{ cotizacion.monto_total|floatformat:2 }}</p>
                    </div>
                </div>

                {% if error %}
                <div class="bg-rose-50 border-l-4 border-rose-500 p-5 mb-8 flex items-center gap-4 animate-shake">
                    <i data-lucide="alert-circle" class="w-5 h-5 text-rose-500"></i>
                    <p class="text-rose-700 text-[11px] font-bold uppercase tracking-wider">{{ error }}</p>
                </div>
                {% endif %}

                <form method="post" enctype="multipart/form-data" id="approvalForm" class="space-y-8">
                    {% csrf_token %}

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-8">
                        <div class="group">
                            <label class="block text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] mb-3 ml-4">
                                <i data-lucide="hash" class="w-3.5 h-3.5 inline mr-1 text-blue-500"></i> Código Operación / Orden
                            </label>
                            <input type="text" name="codigo_voucher" id="id_codigo_voucher"
                                   value="{{ codigo_voucher_value|default_if_none:'' }}" 
                                   class="input-vicaf ml-4" placeholder="EJ: 202509-ABC-1234" required>
                        </div>

                        <div class="group">
                            <label class="block text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] mb-3 ml-4">
                                <i data-lucide="banknote" class="w-3.5 h-3.5 inline mr-1 text-blue-500 ml-2"></i> Importe Pagado (S/.)
                            </label>
                            <input type="number" step="0.01" name="monto_pagado" id="id_monto_pagado"
                                   value="{{ monto_pagado_value|default:cotizacion.monto_total|floatformat:2 }}" 
                                   class="input-vicaf font-mono" required>
                        </div>

                        <div class="group">
                            <label class="block text-[10px] font-black text-slate-500 uppercase tracking-[0.2em] mb-3 ml-4">
                                <i data-lucide="file-text" class="w-3.5 h-3.5 inline mr-1 text-blue-500"></i> Voucher o Comprobante
                            </label>
                            <input type="file" name="imagen_voucher" id="id_imagen_voucher" 
                                   accept="image/*,application/pdf" class="file-vicaf" required>
                        </div>

                        <div class="group">
                            <label class="block text-[10px] font-black text-rose-500 uppercase tracking-[0.2em] mb-3 ml-4">
                                <i data-lucide="signature" class="w-3.5 h-3.5 inline mr-1"></i> Oferta Firmada (PDF)
                            </label>
                            <input type="file" name="documento_firmado_cliente" id="id_documento_firmado_cliente" 
                                   accept="application/pdf" class="file-vicaf border-rose-100" required>
                        </div>
                    </div>

                    <div class="pt-8 flex justify-end">
                        <button type="submit" id="submitBtn" 
                                class="group relative px-12 py-5 bg-blue-600 text-white transition-all hover:bg-emerald-600 active:scale-95 shadow-xl shadow-blue-200 hover:shadow-emerald-200" 
                                style="clip-path: polygon(8% 0, 100% 0, 92% 100%, 0 100%);">
                            <div class="relative z-10 flex items-center gap-4">
                                <i data-lucide="check-circle-2" class="w-5 h-5"></i>
                                <span class="text-[11px] font-black uppercase tracking-[0.25em]">Aprobar y Crear Proyecto</span>
                            </div>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof lucide !== 'undefined') lucide.createIcons();
        const approvalForm = document.getElementById('approvalForm');
        const submitBtn = document.getElementById('submitBtn');

        if (approvalForm && submitBtn) {
            approvalForm.addEventListener('submit', () => {
                submitBtn.disabled = true;
                submitBtn.classList.remove('bg-blue-600', 'hover:bg-emerald-600');
                submitBtn.classList.add('bg-slate-400');
                submitBtn.style.cursor = 'not-allowed';
                
                submitBtn.innerHTML = `
                    <div class="flex items-center gap-4">
                        <i data-lucide="loader-2" class="w-5 h-5 animate-spin"></i>
                        <span class="text-[11px] font-black uppercase tracking-[0.25em]">Procesando...</span>
                    </div>
                `;
                if (typeof lucide !== 'undefined') lucide.createIcons();
            });
        }
    });
</script>
{% endblock %}