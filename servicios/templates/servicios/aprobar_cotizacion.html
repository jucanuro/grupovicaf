{% extends "base_vicafpro.html" %}
{% load static %}

{% block content %}
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&family=JetBrains+Mono:wght@400;500&display=swap');
    
    body { 
        font-family: 'Inter', sans-serif; 
        background-color: #f8fafc;
    }

    /* Fondo Engine Unificado */
    .bg-vicaf-engine {
        position: fixed; inset: 0; z-index: -1; background-color: #f8fafc;
        background-image: linear-gradient(rgba(226, 232, 240, 0.5) 1px, transparent 1px), 
                          linear-gradient(90deg, rgba(226, 232, 240, 0.5) 1px, transparent 1px);
        background-size: 40px 40px;
    }

    /* Estilo de Inputs tipo Engine */
    .input-engine {
        /* w-full es la clave para el ancho total */
        @apply w-full px-4 py-2.5 bg-slate-50 border border-slate-200 rounded-lg text-xs font-bold text-slate-700 transition-all outline-none focus:bg-white focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10;
    }

    .file-engine {
        @apply block w-full text-[10px] text-slate-500 font-bold uppercase border border-slate-200 rounded-lg bg-slate-50/50 cursor-pointer overflow-hidden;
    }
    
    .file-engine::file-selector-button {
        @apply mr-4 py-2.5 px-6 border-0 text-[9px] font-black uppercase tracking-widest bg-slate-900 text-white transition-colors cursor-pointer;
    }
    .file-engine:hover::file-selector-button { @apply bg-indigo-600; }
</style>

<div class="bg-vicaf-engine"></div>

<div class="max-w-7xl mx-auto p-4 relative z-10 space-y-6">
    
    <header class="bg-white border border-slate-200 rounded-xl shadow-sm flex items-center justify-between p-4">
        <div class="flex items-center gap-4">
            <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-blue-200">
                <i data-lucide="check-square" class="w-5 h-5"></i>
            </div>
            <div>
                <h1 class="text-lg font-extrabold text-slate-900 tracking-tight leading-none uppercase">Aprobación y Cierre</h1>
                <p class="text-[9px] font-mono text-blue-600 mt-1 uppercase tracking-[0.2em]">Validación de Pago && Apertura de Proyecto</p>
            </div>
        </div>
        <a href="{% url 'servicios:lista_cotizaciones' %}" class="bg-slate-100 text-slate-600 px-4 py-2 rounded-lg text-xs font-bold hover:bg-slate-900 hover:text-white transition-all flex items-center gap-2">
            <i data-lucide="arrow-left" class="w-3.5 h-3.5"></i> VOLVER
        </a>
    </header>

    <div class="bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden transition-all duration-300">
        
        <div class="px-8 py-6 bg-slate-50/50 border-b border-slate-100 grid grid-cols-1 md:grid-cols-3 gap-8">
            <div>
                <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Documento de Referencia</p>
                <div class="flex items-center gap-2">
                    <span class="bg-slate-900 text-white text-[11px] font-black px-3 py-1 rounded-md tracking-tighter">
                        {{ cotizacion.numero_oferta }}
                    </span>
                </div>
            </div>
            <div>
                <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Cliente Vinculado</p>
                <p class="font-bold text-slate-800 text-xs uppercase truncate">{{ cotizacion.cliente.razon_social }}</p>
            </div>
            <div>
                <p class="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1">Monto Contractual</p>
                <p class="font-mono text-sm font-black text-blue-600">S/ {{ cotizacion.monto_total|floatformat:2 }}</p>
            </div>
        </div>

        <div class="p-8">
            {% if error %}
            <div class="bg-rose-50 border border-rose-100 rounded-xl p-4 mb-8 flex items-center gap-4 animate-pulse">
                <i data-lucide="alert-octagon" class="w-5 h-5 text-rose-500"></i>
                <p class="text-rose-700 text-[10px] font-bold uppercase tracking-wider">{{ error }}</p>
            </div>
            {% endif %}

            <form method="post" enctype="multipart/form-data" id="approvalForm" class="space-y-8">
                {% csrf_token %}

                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-10 gap-y-6">
                    
                    <div class="space-y-2 w-full"> <label class="flex items-center gap-2 text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1">
                        <i data-lucide="hash" class="w-3 h-3 text-indigo-500"></i> Código Operación / O.C.
                    </label>
                    <input type="text" name="codigo_voucher" id="id_codigo_voucher"
                        value="{{ codigo_voucher_value|default_if_none:'' }}" 
                        class="input-engine w-full px-2" 
                        placeholder="INGRESAR N° DE VOUCHER O PEDIDO" required>
                </div>

                    <div class="space-y-2">
                        <label class="flex items-center gap-2 text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1">
                            <i data-lucide="banknote" class="w-3 h-3 text-emerald-500"></i> Importe Liquidado (S/.)
                        </label>
                        <input type="number" step="0.01" name="monto_pagado" id="id_monto_pagado"
                               value="{{ monto_pagado_value|default:cotizacion.monto_total|floatformat:2 }}" 
                               class="input-engine font-mono text-indigo-600" required>
                    </div>

                    <div class="space-y-2">
                        <label class="flex items-center gap-2 text-[10px] font-bold text-slate-500 uppercase tracking-widest ml-1">
                            <i data-lucide="file-up" class="w-3 h-3 text-slate-400"></i> Voucher de Depósito
                        </label>
                        <input type="file" name="imagen_voucher" id="id_imagen_voucher" 
                               accept="image/*,application/pdf" class="file-engine" required>
                    </div>

                    <div class="space-y-2">
                        <label class="flex items-center gap-2 text-[10px] font-bold text-rose-500 uppercase tracking-widest ml-1">
                            <i data-lucide="signature" class="w-3 h-3"></i> Oferta Firmada (PDF)
                        </label>
                        <input type="file" name="documento_firmado_cliente" id="id_documento_firmado_cliente" 
                               accept="application/pdf" class="file-engine border-rose-200 bg-rose-50/30" required>
                    </div>
                </div>

                <div class="pt-6 border-t border-slate-100 flex justify-end">
                    <button type="submit" id="submitBtn" 
                            class="group bg-slate-900 text-white px-10 py-4 rounded-xl text-[11px] font-black uppercase tracking-[0.2em] hover:bg-blue-600 transition-all flex items-center gap-4 shadow-xl shadow-slate-200 hover:shadow-blue-200 active:scale-95">
                        <i data-lucide="rocket" class="w-4 h-4 group-hover:animate-bounce"></i>
                        GENERAR PROYECTO AHORA
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof lucide !== 'undefined') lucide.createIcons();
        
        const approvalForm = document.getElementById('approvalForm');
        const submitBtn = document.getElementById('submitBtn');

        if (approvalForm && submitBtn) {
            approvalForm.addEventListener('submit', () => {
                submitBtn.disabled = true;
                submitBtn.classList.replace('bg-slate-900', 'bg-slate-400');
                submitBtn.style.cursor = 'not-allowed';
                
                submitBtn.innerHTML = `
                    <i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i>
                    PROCESANDO ENGINE...
                `;
                if (typeof lucide !== 'undefined') lucide.createIcons();
            });
        }
    });
</script>
{% endblock %}