{% extends "base_vicafpro.html" %}
{% load static %}
{% block content %}
<style>
    /* cotizaciones.css - Actualizado con estilos solicitados */

:root {
    --color-bg-main: #0F172A;
    --color-bg-card: #1E293B;
    --color-border: #475569;
    --color-text-light: #F1F5F9;
    --color-text-faded: #FFFFFF;
    --color-primary: #0EA5E9;
    --color-secondary: #0D9488;
    --color-accent-green: #22C55E;
    --color-accent-red: #EF4444;
    --color-bg-input: #1E3A8A;
}

body {
    background-color: var(--color-bg-main);
    color: var(--color-text-light);
}

#quote-container {
    max-width: 1200px;
    margin: 2rem auto;
    padding: 2rem;
    background-color: var(--color-bg-card);
    border-radius: 1rem;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
}

h2 {
    color: var(--color-text-light);
    border-bottom: 2px solid var(--color-border);
    padding-bottom: 0.5rem;
    margin-bottom: 1.5rem;
}
.glass-card h3 {
    color: var(--color-text-light) !important;
}

.form-group-v2 {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    margin-bottom: 1rem;
}

.form-label-v2 {
    font-size: 0.8rem;
    color: var(--color-text-faded) !important;
    font-weight: 500;
    transition: all 0.2s ease-in-out;
}

.form-control-v2 {
    width: 100%;
    padding: 0.5rem 0.75rem;
    background-color: var(--color-bg-input) !important;
    border: 1px solid var(--color-border);
    border-radius: 0.5rem;
    color: #FFFFFF !important;
    font-size: 0.9rem;
    transition: all 0.2s ease-in-out;
    outline: none;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.form-control-v2:focus {
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px rgba(14, 165, 233, 0.5);
}

.form-control-v2.form-select-v2 {
    background-color: var(--color-bg-input) !important;
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23F1F5F9' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.75rem center;
    background-repeat: no-repeat;
    background-size: 1.5rem;
    padding-right: 2.5rem;
    -webkit-appearance: none;
    -moz-appearance: none;
    appearance: none;
}

.form-control-v2[readonly] {
    cursor: not-allowed;
    background-color: var(--color-bg-input) !important; 
    color: var(--color-text-light) !important; 
}

.no-arrows::-webkit-outer-spin-button,
.no-arrows::-webkit-inner-spin-button {
    -webkit-appearance: none;
    margin: 0;
}
.no-arrows {
    -moz-appearance: textfield;
}

.ts-wrapper.form-control-v2 {
    padding: 0;
    border: none;
    background-color: transparent;
}
.ts-control {
    background-color: var(--color-bg-input) !important;
    border-color: #475569;
    color: var(--color-text-light);
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border-radius: 0.5rem;
    transition: all 0.2s ease-in-out;
    padding: 0.5rem 0.75rem;
}
.ts-control .ts-input {
    background-color: transparent !important;
    border: none !important;
    color: var(--color-text-light) !important;
    padding: 0;
    font-size: 0.9rem;
    min-height: 1.5rem;
}
.ts-control .ts-input input {
    background-color: var(--color-bg-input) !important;
    color: #FFFFFF !important;
    padding: 0;
    height: auto !important;
}

.ts-dropdown {
    background-color: #1E293B;
    border-color: #475569;
    border-radius: 0.5rem;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}
.ts-dropdown .option {
    color: var(--color-text-light);
    padding: 0.5rem 0.75rem;
}
.ts-dropdown .option.active, .ts-dropdown .option.selected {
    background-color: #334155;
    color: var(--color-primary);
}
.ts-control::after {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%23F1F5F9' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='M6 8l4 4 4-4'/%3e%3c/svg'%3e");
    right: 0.75rem;
    transform: none;
}
.ts-control.single::after {
    border-color: transparent !important;
}

.item-row-v2 {
    display: grid;
    grid-template-columns: 2.5fr 1fr 1fr 0.5fr 0.5fr 0.8fr 1fr 0.2fr;
    gap: 0.75rem;
    padding: 0.75rem;
    background-color: rgba(30, 41, 59, 0.7);
    border-radius: 0.5rem;
    border: 1px solid #475569;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
    transition: all 0.3s ease-in-out;
    align-items: center;
    margin-bottom: 0.5rem;
}

.item-row-v2-header {
    font-weight: bold;
    color: var(--color-primary);
    padding: 0.75rem;
    border-bottom: 2px solid var(--color-border);
    margin-bottom: 0.5rem;
}

.item-row-v2:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
}

.item-row-v2 .subtotal-cell {
    min-width: 60px;
    font-weight: bold;
    color: var(--color-accent-green);
    text-align: right;
    padding-right: 0.5rem;
}

.item-row-v2 .remove-item-btn {
    background: none;
    border: none;
    color: var(--color-accent-red);
    cursor: pointer;
    font-size: 1.2rem;
    padding: 0;
    line-height: 1;
    transition: color 0.2s;
    display: flex;
    justify-content: center;
    align-items: center;
}

.item-row-v2 .remove-item-btn:hover {
    color: #FF7777;
}

.grid-container-2-cols {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1.5rem;
}

.grid-container-3-cols {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1.5rem;
}

.grid-container-4-cols {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1.5rem;
}

.totals-area {
    margin-top: 1.5rem;
    padding: 1rem;
    background-color: rgba(14, 165, 233, 0.1);
    border-radius: 0.5rem;
    border: 1px solid var(--color-primary);
}

.total-row {
    display: flex;
    justify-content: space-between;
    font-size: 1.1rem;
    padding: 0.3rem 0;
}

.total-row.grand-total {
    font-size: 1.5rem;
    font-weight: bold;
    color: var(--color-accent-green);
    border-top: 1px dashed var(--color-border);
    padding-top: 0.5rem;
    margin-top: 0.5rem;
}

.btn-primary-v2 {
    background-color: var(--color-primary);
    color: var(--color-text-light);
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    transition: background-color 0.2s, transform 0.1s;
}

.btn-primary-v2:hover {
    background-color: #0C8AC7;
    transform: translateY(-1px);
}

.btn-secondary-v2 {
    background-color: var(--color-secondary);
    color: var(--color-text-light);
    border: none;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    cursor: pointer;
    font-size: 1rem;
    font-weight: 600;
    transition: background-color 0.2s, transform 0.1s;
}

.btn-secondary-v2:hover {
    background-color: #0B7E74;
    transform: translateY(-1px);
}
</style>
<div class="space-y-8 p-4">
    <header class="flex flex-col md:flex-row items-start md:items-center justify-between gap-6 animate-fade-in-up">
        <h1 class="text-2xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-cyan-300">
            {% if cotizacion %}Editar Cotizaci贸n{% else %}Crear Nueva Cotizaci贸n{% endif %}
        </h1>
        <a href="{% url 'servicios:lista_cotizaciones' %}" class="inline-flex items-center gap-2 px-6 py-2 bg-slate-800 text-white font-semibold rounded-full hover:bg-slate-700 transition-all duration-300 transform hover:scale-105 shadow-lg">
            <i data-lucide="list" class="w-5 h-5"></i>
            Regresar a la Lista
        </a>
    </header>

    {% if error %}
    <div class="p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-500/30" role="alert">
        <span class="font-medium">Error de Guardado:</span> {{ error }}
    </div>
    {% endif %}

    <form method="post" class="space-y-8" id="cotizacion-form">
        {% csrf_token %}

        <div class="glass-card p-6 rounded-2xl shadow-xl animate-fade-in-up bg-slate-800/50 backdrop-blur-sm border border-slate-700">
            <h2 class="text-xl font-bold text-white mb-6">Datos de la Oferta</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-12 gap-x-12 gap-y-4">
                <div class="space-y-6 md:col-span-7">
                    <h3 class="text-lg font-semibold text-white border-b border-slate-700 pb-2">Empresa y Contacto</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                        
                        <div class="form-group-v2">
                            <label for="id_cliente_ruc" class="form-label-v2">RUC del Cliente</label>
                            <select id="id_cliente_ruc" name="cliente" class="form-control-v2 form-select-v2 tom-select-js" required>
                                <option value="" selected disabled>Buscar RUC o Raz贸n Social...</option> 
                                {% for cliente in clientes %}
                                <option value="{{ cliente.pk }}" data-razon-social="{{ cliente.razon_social }}" data-contacto="{{ cliente.nombre_contacto }}" data-correo="{{ cliente.correo }}" data-telefono="{{ cliente.telefono }}" {% if cotizacion and cotizacion.cliente.pk == cliente.pk %}selected{% endif %}>
                                    {{ cliente.ruc }} - {{ cliente.razon_social }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="form-group-v2">
                            <label for="id_razon_social" class="form-label-v2">Raz贸n Social</label>
                            <input type="text" id="id_razon_social" class="form-control-v2" readonly placeholder="Raz贸n Social">
                        </div>
                        
                        <div class="form-group-v2">
                            <label for="id_persona_contacto" class="form-label-v2">Persona de Contacto</label>
                            <input type="text" name="persona_contacto" id="id_persona_contacto" class="form-control-v2" required placeholder="Persona de Contacto" {% if cotizacion %}value="{{ cotizacion.persona_contacto }}"{% endif %}>
                        </div>

                        <div class="form-group-v2">
                            <label for="id_telefono_contacto" class="form-label-v2">Tel茅fono</label>
                            <input type="text" name="telefono_contacto" id="id_telefono_contacto" class="form-control-v2" required placeholder="Tel茅fono" {% if cotizacion %}value="{{ cotizacion.telefono_contacto }}"{% endif %}>
                        </div>
                        
                        <div class="form-group-v2 md:col-span-2">
                            <label for="id_correo_contacto" class="form-label-v2">Correo</label>
                            <input type="email" name="correo_contacto" id="id_correo_contacto" class="form-control-v2" required placeholder="Correo" {% if cotizacion %}value="{{ cotizacion.correo_contacto }}"{% endif %}>
                        </div>
                    </div>
                </div>
                <div class="space-y-6 md:col-span-5">
                    <h3 class="text-lg font-semibold text-white border-b border-slate-700 pb-2">Detalle de la Oferta</h3>
                    
                    <div class="form-group-v2">
                        <label for="id_servicio_general" class="form-label-v2">Servicio General / Categor铆a</label>
                        <select id="id_servicio_general" name="servicio_general" class="form-control-v2 form-select-v2 tom-select-js">
                            <option value="" selected disabled>Seleccionar Categor铆a de Servicio...</option> 
                            {% for group in servicio_grupos %}
                            <option value="{{ group.pk }}" {% if cotizacion and cotizacion.servicio_general.pk == group.pk %}selected{% endif %}>
                                {{ group.nombre }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="form-group-v2">
                        <label for="id_asunto_servicio" class="form-label-v2">Asunto del Servicio / Descripci贸n General</label>
                        <input type="text" name="asunto_servicio" id="id_asunto_servicio" class="form-control-v2" required placeholder="Ej: Ensayo de suelos para Proyecto X" {% if cotizacion %}value="{{ cotizacion.asunto_servicio }}"{% endif %}>
                    </div>
                    
                </div>
            </div>
            
            <input type="hidden" name="tasa_igv" id="tasa_igv" value="{% if cotizacion %}{{ cotizacion.tasa_igv }}{% else %}0.18{% endif %}">
        </div>
        
        <div class="glass-card p-6 rounded-2xl shadow-xl animate-fade-in-up bg-slate-800/50 backdrop-blur-sm border border-slate-700">
            <div class="flex flex-col md:flex-row justify-between items-center mb-6">
                <h2 class="text-xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-sky-400 to-cyan-300">
                    Detalle de la Cotizaci贸n
                </h2>
                <button type="button" id="addItemBtn" class="mt-4 md:mt-0 inline-flex items-center gap-2 px-6 py-2 bg-gradient-to-r from-green-500 to-emerald-500 text-white font-semibold rounded-full hover:from-green-600 hover:to-emerald-600 transition-all duration-300 transform hover:scale-105 shadow-lg">
                    <i data-lucide="plus" class="w-5 h-5"></i>
                    Agregar tem
                </button>
            </div>
            
            <div id="cotizacion-detalles" class="space-y-6">
                </div>

            <template id="item-row-template">
                <div class="item-row-v2 animate-fade-in-up">
                    <div class="form-group-v2">
                        <label class="form-label-v2">Servicio</label>
                        <select class="form-control-v2 form-select-v2 servicio-select" required>
                            <option value="" selected disabled>Seleccionar Servicio</option>
                        </select>
                        <input type="hidden" class="descripcion-input">
                    </div>
                    <div class="form-group-v2">
                        <label class="form-label-v2">Norma</label>
                        <select class="form-control-v2 form-select-v2 normas-select">
                            <option value="">N/A</option>
                        </select>
                    </div>
                    <div class="form-group-v2">
                        <label class="form-label-v2">M茅todo</label>
                        <select class="form-control-v2 form-select-v2 metodos-select">
                            <option value="">N/A</option>
                        </select>
                    </div>
                    <div class="form-group-v2">
                        <label class="form-label-v2">Unidad</label>
                        <input type="text" class="form-control-v2 text-center und-input" required placeholder="Und.">
                    </div>
                    <div class="form-group-v2">
                        <label class="form-label-v2">Cantidad</label>
                        <input type="number" class="form-control-v2 text-center cantidad-input no-arrows" min="1" value="1" required placeholder="Cant.">
                    </div>
                    <div class="form-group-v2">
                        <label class="form-label-v2">Precio</label>
                        <input type="number" class="form-control-v2 text-center precio-input no-arrows" step="0.01" min="0.01" value="0.00" required placeholder="Precio">
                    </div>
                    <div class="flex flex-col items-start text-sm font-bold text-green-400">
                        <span class="text-sm text-slate-400">Subtotal:</span>
                        S/. <span class="subtotal-cell text-sm">0.00</span>
                    </div>
                    <div class="flex justify-center">
                        <button type="button" class="remove-item-btn p-2 text-rose-400 hover:bg-rose-500/20 rounded-full transition-colors">
                            <i data-lucide="trash-2" class="w-5 h-5"></i>
                        </button>
                    </div>
                </div>
            </template>
        </div>

        <div class="glass-card p-6 rounded-2xl shadow-xl animate-fade-in-up bg-slate-800/50 backdrop-blur-sm border border-slate-700">
            <h2 class="text-xl font-bold text-white mb-6">Condiciones y Totales</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">
                <div class="space-y-4">
                    <div class="form-group-v2">
                        <label for="id_forma_pago" class="form-label-v2">Forma de Pago</label>
                        <select name="forma_pago" id="id_forma_pago" class="form-control-v2 form-select-v2 tom-select-js">
                            <option value="Credito 30" {% if cotizacion and cotizacion.forma_pago == 'Credito 30' %}selected{% endif %}>Cr茅dito 30 d铆as</option>
                            <option value="Contado" {% if cotizacion and cotizacion.forma_pago == 'Contado' %}selected{% endif %}>Contado</option>
                            <option value="Anticipo 50" {% if cotizacion and cotizacion.forma_pago == 'Anticipo 50' %}selected{% endif %}>50% Anticipo, 50% Contra Entrega</option>
                        </select>
                    </div>
                    <div class="form-group-v2">
                        <label for="id_validez_oferta_dias" class="form-label-v2">Validez (d铆as)</label>
                        <input type="number" name="validez_oferta_dias" id="id_validez_oferta_dias" class="form-control-v2" placeholder="Validez" min="1" value="{% if cotizacion %}{{ cotizacion.validez_oferta_dias }}{% else %} {% endif %}">
                    </div>
                    <div class="form-group-v2">
                        <label for="id_plazo_entrega_dias" class="form-label-v2">Plazo de Entrega (d铆as)</label>
                        <input type="number" name="plazo_entrega_dias" id="id_plazo_entrega_dias" class="form-control-v2" placeholder="Plazo de Entrega" min="30" value="{% if cotizacion %}{{ cotizacion.plazo_entrega_dias }}{% else %} {% endif %}">
                    </div>
                </div>
                <div class="flex flex-col justify-end items-end space-y-4 mt-8 md:mt-0 text-right">
                    <div class="w-full max-w-sm">
                        <div class="flex justify-between items-center text-slate-300 font-medium text-lg">
                            <span>Subtotal:</span>
                            <span>S/. <span id="subtotal_cotizacion">0.00</span></span>
                        </div>
                        <div class="flex justify-between items-center text-slate-300 font-medium text-lg">
                            <span>IGV (18%):</span>
                            <span>S/. <span id="igv_cotizacion">0.00</span></span>
                        </div>
                        <div class="h-px bg-slate-700 my-2"></div>
                        <div class="flex justify-between items-center text-3xl font-bold text-green-400">
                            <span>Total:</span>
                            <span>S/. <span id="total_final_cotizacion">0.00</span></span>
                        </div>
                    </div>
                    <input type="hidden" name="monto_total" id="id_monto_total" value="0.00">
                    <input type="hidden" name="detalles_json" id="detalles_json">
                </div>
            </div>
        </div>

        <div class="flex justify-end mt-8 animate-fade-in-up">
            <button type="submit" class="inline-flex items-center gap-2 px-8 py-3 bg-gradient-to-r from-blue-500 to-sky-500 text-white font-bold rounded-full hover:from-blue-600 hover:to-sky-600 transition-all duration-300 transform hover:scale-105 shadow-lg shadow-blue-500/30 focus:outline-none focus:ring-4 focus:ring-blue-400">
                <i data-lucide="save" class="w-5 h-5"></i>
                Guardar Cotizaci贸n
            </button>
        </div>
    </form>
</div>
<script src="https://unpkg.com/lucide@latest"></script>
<script>
    lucide.createIcons();
</script>
<script id="all-services-data" type="application/json">
    {{ servicios_con_detalles_json|safe }}
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- Variables Globales ---
    let ALL_SERVICES_DATA = [];
    let servicesDataLoaded = false;
    let categoriaTomSelectInstance = null; // Variable para la instancia TomSelect de la categor铆a

    // Inicializar Lucide Icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }

    // Elementos del Encabezado y Cliente
    const clientesSelect = document.getElementById('id_cliente_ruc');
    const formaPagoSelect = document.getElementById('id_forma_pago');
    const categoriaServicioSelect = document.getElementById('id_servicio_general'); // El select del encabezado

    const razonSocialInput = document.getElementById('id_razon_social');
    const personaContactoInput = document.getElementById('id_persona_contacto');
    const correoContactoInput = document.getElementById('id_correo_contacto');
    const telefonoContactoInput = document.getElementById('id_telefono_contacto');

    // Elementos de Detalle y Totales
    const detallesContainer = document.getElementById('cotizacion-detalles'); 
    const addItemBtn = document.getElementById('addItemBtn');
    const cotizacionForm = document.getElementById('cotizacion-form');
    
    const subtotalSpan = document.getElementById('subtotal_cotizacion');
    const igvSpan = document.getElementById('igv_cotizacion');
    const totalFinalSpan = document.getElementById('total_final_cotizacion');
    const montoTotalInput = document.getElementById('id_monto_total');
    const detallesJsonInput = document.getElementById('detalles_json');
    const tasaIgvInput = document.getElementById('id_tasa_igv');

    // --- L贸gica de Inicializaci贸n de Datos ---

    // 1. Carga los datos JSON de servicios
    const loadAllServicesData = () => {
        const dataElement = document.getElementById('all-services-data');
        if (dataElement) {
            try {
                ALL_SERVICES_DATA = JSON.parse(dataElement.textContent || '[]');
                servicesDataLoaded = true;
            } catch (e) {
                console.error("Error al parsear el JSON de servicios:", e);
            }
        }
    };

    // Funci贸n para cargar datos del cliente
    const loadClientData = (selectedOption) => {
        if (selectedOption) {
            razonSocialInput.value = selectedOption.dataset.razonSocial || '';
            personaContactoInput.value = selectedOption.dataset.contacto || '';
            correoContactoInput.value = selectedOption.dataset.correo || '';
            telefonoContactoInput.value = selectedOption.dataset.telefono || '';
        } else {
            razonSocialInput.value = '';
            personaContactoInput.value = '';
            correoContactoInput.value = '';
            telefonoContactoInput.value = '';
        }
    };

    // Funci贸n de inicializaci贸n de Tom-select
    const initializeTomSelect = (element, options = {}) => {
        if (typeof TomSelect !== 'undefined' && element) {
            if (element.tomselect) {
                element.tomselect.destroy();
            }
            const defaultOptions = element.matches('.servicio-select') ? {
                render: {
                    option: function(item, escape) { return `<div>${escape(item.text)}</div>`; },
                    item: function(item, escape) { return `<div>${escape(item.text)}</div>`; }
                }
            } : {};

            const instance = new TomSelect(element, {
                create: false,
                sortField: {
                    field: "text",
                    direction: "asc"
                },
                placeholder: element.getAttribute('data-placeholder') || 'Seleccione...',
                allowEmptyOption: true,
                ...defaultOptions,
                ...options
            });

            // Guardar la instancia de la categor铆a principal
            if (element === categoriaServicioSelect) {
                categoriaTomSelectInstance = instance;
            }
        }
    };
    
    // Funci贸n para poblar el SELECT de servicio con base en la Categor铆a seleccionada
    const populateServiciosSelect = (selectElement, selectedServicioId) => {
        if (!servicesDataLoaded) return;
        
        let tomSelectInstance = selectElement.tomselect;
        
        if (!tomSelectInstance) {
            initializeTomSelect(selectElement);
            tomSelectInstance = selectElement.tomselect;
            if (!tomSelectInstance) return;
        }

        // Obtener el valor de la categor铆a de la INSTANCIA de TomSelect (la fuente de verdad)
        let selectedCategoriaId = '';
        if (categoriaTomSelectInstance) {
            selectedCategoriaId = String(categoriaTomSelectInstance.getValue() || '');
        } else {
            selectedCategoriaId = String(categoriaServicioSelect.value || '');
        }
        
        tomSelectInstance.clearOptions();
        
        // Opci贸n por defecto (Placeholder)
        tomSelectInstance.addOption({
            value: '', 
            text: 'Seleccione servicio', 
            disabled: true, 
            selected: true
        });

        let servicesToUse = [];

        // Filtrar solo si la categor铆a seleccionada tiene un valor
        if (selectedCategoriaId) {
            servicesToUse = ALL_SERVICES_DATA.filter(service => {
                const serviceCategoriaId = String(service.categoria_id); 
                // Compara la ID de la categor铆a del servicio con la ID seleccionada (ambas strings)
                return serviceCategoriaId === selectedCategoriaId; 
            }).map(service => ({
                value: String(service.pk),
                text: service.nombre
            }));
        }
        
        // Agregar servicios filtrados
        if (servicesToUse.length > 0) {
            tomSelectInstance.addOptions(servicesToUse);
        }
        
        // Seleccionar el valor guardado si existe en las nuevas opciones
        if (selectedServicioId && tomSelectInstance.options[String(selectedServicioId)]) {
             tomSelectInstance.setValue(String(selectedServicioId), true);
        } else {
             // Si el servicio anterior no est谩 en la nueva categor铆a, lo deselecciona.
             tomSelectInstance.setValue('', true);
        }
        
        tomSelectInstance.refreshOptions(false);
    };

    // Funci贸n para generar el HTML de una fila de 铆tem
    const createItemRowHTML = (servicioId = '', cantidad = '1', precio = '0.00', und = 'und', normaId = '', metodoId = '') => {
        return `
            <div class="item-row-v2 animate-fade-in-up" data-servicio-id="${servicioId}" data-norma-id="${normaId}" data-metodo-id="${metodoId}">
                <div class="form-group-v2">
                    <label class="form-label-v2">Servicio</label>
                    <select class="form-control-v2 form-select-v2 servicio-select tom-select-js" required name="servicio" data-placeholder="Seleccione servicio">
                        <option value="" disabled selected>Seleccione servicio</option>
                    </select>
                </div>
                <div class="form-group-v2">
                    <label class="form-label-v2">Norma</label>
                    <select class="form-control-v2 form-select-v2 normas-select" name="norma" data-placeholder="Seleccione norma">
                        <option value="" disabled selected>Seleccione norma</option>
                    </select>
                </div>
                <div class="form-group-v2">
                    <label class="form-label-v2">M茅todo</label>
                    <select class="form-control-v2 form-select-v2 metodos-select" name="metodo" data-placeholder="Seleccione m茅todo">
                        <option value="" disabled selected>Seleccione m茅todo</option>
                    </select>
                </div>
                <div class="form-group-v2">
                    <label class="form-label-v2">Unidad</label>
                    <input type="text" class="form-control-v2 text-center und-input" value="${und}" name="und" placeholder="Und.">
                </div>
                <div class="form-group-v2">
                    <label class="form-label-v2">Cantidad</label>
                    <input type="number" class="form-control-v2 text-center cantidad-input no-arrows" min="1" value="${cantidad}" required placeholder="Cant.">
                </div>
                <div class="form-group-v2">
                    <label class="form-label-v2">Precio</label>
                    <input type="number" class="form-control-v2 text-center precio-input no-arrows" step="0.01" value="${precio}" required placeholder="Precio">
                </div>
                <div class="flex flex-col items-end text-lg font-bold text-green-400">
                    <span class="text-sm text-slate-400">Subtotal:</span>
                    S/. <span class="subtotal-cell">0.00</span>
                </div>
                <div class="flex justify-center">
                    <button type="button" class="remove-item-btn p-2 text-rose-400 hover:bg-rose-500/20 rounded-full transition-colors">
                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                    </button>
                </div>
            </div>
        `;
    };

    // Funci贸n para a帽adir una nueva fila de 铆tem
    const addRow = (servicioId = '', cantidad = '1', precio = '0.00', und = 'und', normaId = '', metodoId = '') => {
        const rowHTML = createItemRowHTML(servicioId, cantidad, precio, und, normaId, metodoId);
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = rowHTML.trim();
        const newRow = tempDiv.firstChild;
        detallesContainer.appendChild(newRow);
        
        if (typeof lucide !== 'undefined') {
            lucide.createIcons();
        }

        const servicioSelect = newRow.querySelector('.servicio-select');
        initializeTomSelect(servicioSelect);

        if (servicioId) {
            loadServiceData(servicioSelect, normaId, metodoId);
        } else {
             updateTotals(); 
        }
    };
    
    // Funci贸n para cargar los datos del servicio seleccionado (precio, unidad, normas, m茅todos)
    const loadServiceData = async (selectElement, selectedNormaId, selectedMetodoId) => {
        const pk = selectElement.value;
        const row = selectElement.closest('.item-row-v2'); 
        const precioInput = row.querySelector('.precio-input');
        const undInput = row.querySelector('.und-input');
        const normasSelect = row.querySelector('.normas-select');
        const metodosSelect = row.querySelector('.metodos-select');

        if (normasSelect && normasSelect.tomselect) normasSelect.tomselect.destroy();
        if (metodosSelect && metodosSelect.tomselect) metodosSelect.tomselect.destroy();

        normasSelect.innerHTML = '<option value="" disabled selected>Seleccione norma</option>';
        metodosSelect.innerHTML = '<option value="" disabled selected>Seleccione m茅todo</option>';

        if (pk) {
            try {
                const url = `{% url 'servicios:obtener_detalle_servicio_para_cotizacion_api' pk=999999 %}`.replace('999999', pk);
                const response = await fetch(url);
                const servicio = await response.json();
                
                precioInput.value = parseFloat(servicio.precio_unitario).toFixed(2);
                undInput.value = servicio.und || '';

                if (servicio.normas && servicio.normas.length > 0) {
                    servicio.normas.forEach(norma => {
                        const option = document.createElement('option');
                        option.value = norma.id;
                        option.textContent = norma.nombre;
                        if (String(norma.id) === String(selectedNormaId)) option.selected = true;
                        normasSelect.appendChild(option);
                    });
                }
                if (servicio.metodos && servicio.metodos.length > 0) {
                    servicio.metodos.forEach(metodo => {
                        const option = document.createElement('option');
                        option.value = metodo.id;
                        option.textContent = metodo.nombre;
                        if (String(metodo.id) === String(selectedMetodoId)) option.selected = true;
                        metodosSelect.appendChild(option);
                    });
                }

                if (typeof TomSelect !== 'undefined') {
                    initializeTomSelect(normasSelect, {placeholder: 'Seleccione norma'});
                    initializeTomSelect(metodosSelect, {placeholder: 'Seleccione m茅todo'});
                }

            } catch (error) {
                console.error('Error al cargar datos del servicio mediante API:', error);
                precioInput.value = '0.00';
                undInput.value = '';
            }
        } else {
            precioInput.value = '0.00';
            undInput.value = '';
        }
        updateTotals();
    };

    // Funci贸n para actualizar todos los selects de servicio en la p谩gina
    //  ACEPTA UN BOOLEANO PARA SABER SI ES UN CAMBIO DE CATEGORA PRINCIPAL
    const updateAllServiceSelects = (isMasterCategoryChange = false) => {
        detallesContainer.querySelectorAll('.item-row-v2').forEach(row => {
            const servicioSelect = row.querySelector('.servicio-select');
            
            // Si es un cambio de categor铆a principal, forzamos la deselecci贸n
            if (isMasterCategoryChange) {
                if (servicioSelect.tomselect) {
                    servicioSelect.tomselect.setValue('', true); // Limpiar selecci贸n en TomSelect
                }
                // Limpiar data attributes de la fila y valores de otros campos
                row.dataset.servicioId = ''; 
                
                const normasSelect = row.querySelector('.normas-select');
                const metodosSelect = row.querySelector('.metodos-select');
                const precioInput = row.querySelector('.precio-input');
                const undInput = row.querySelector('.und-input');
                
                if (normasSelect.tomselect) normasSelect.tomselect.setValue('', true);
                if (metodosSelect.tomselect) metodosSelect.tomselect.setValue('', true);
                
                row.dataset.normaId = '';
                row.dataset.metodoId = '';
                precioInput.value = '0.00';
                undInput.value = '';
            }
            
            // Obtener el ID de servicio a intentar mantener (ser谩 nulo/vac铆o si se acaba de resetear)
            const selectedServicioId = servicioSelect.value || row.dataset.servicioId; 

            populateServiciosSelect(servicioSelect, selectedServicioId); 
            
            // Si despu茅s de poblar tenemos un valor (solo pasar铆a si NO hubo un reset o es carga inicial)
            if (servicioSelect.value) {
                loadServiceData(servicioSelect, row.dataset.normaId, row.dataset.metodoId);
            }
        });
        updateTotals(); 
    };

    // Funci贸n para recalcular totales y preparar el JSON de detalles
    const updateTotals = () => {
        let subtotal = 0;
        const detalles = [];
        const tasaIgv = parseFloat(tasaIgvInput ? tasaIgvInput.value : 0.18) || 0.18; 

        detallesContainer.querySelectorAll('.item-row-v2').forEach(row => { 
            const servicioSelect = row.querySelector('.servicio-select');
            const cantidadInput = row.querySelector('.cantidad-input');
            const precioInput = row.querySelector('.precio-input');
            const subtotalCell = row.querySelector('.subtotal-cell');
            const undInput = row.querySelector('.und-input');
            const normasSelect = row.querySelector('.normas-select');
            const metodosSelect = row.querySelector('.metodos-select');

            const servicioId = servicioSelect.value;
            const cantidad = parseFloat(cantidadInput.value) || 0;
            const precio = parseFloat(precioInput.value) || 0;
            const itemSubtotal = cantidad * precio;

            subtotal += itemSubtotal;
            subtotalCell.textContent = itemSubtotal.toFixed(2);

            if (servicioId) {
                detalles.push({
                    servicio_id: servicioId,
                    cantidad: cantidad,
                    precio_unitario: precio.toFixed(2),
                    und: undInput.value,
                    norma_id: normasSelect.value || null,
                    metodo_id: metodosSelect.value || null
                });
            }
        });

        const igv = subtotal * tasaIgv; 
        const totalFinal = subtotal + igv;
        
        subtotalSpan.textContent = subtotal.toFixed(2);
        igvSpan.textContent = igv.toFixed(2);
        totalFinalSpan.textContent = totalFinal.toFixed(2);
        montoTotalInput.value = totalFinal.toFixed(2);
        detallesJsonInput.value = JSON.stringify(detalles);
    };

    // --- Listeners de Eventos ---
    
    //  Listener modificado: Pasa 'true' al cambiar la categor铆a principal
    categoriaServicioSelect.addEventListener('change', () => updateAllServiceSelects(true));
    
    if (tasaIgvInput) {
        tasaIgvInput.addEventListener('input', updateTotals);
    }
    
    clientesSelect.addEventListener('change', (e) => {
        const selectedOption = clientesSelect.options[clientesSelect.selectedIndex];
        loadClientData(selectedOption);
    });

    addItemBtn.addEventListener('click', () => {
        addRow();
        // Llama sin argumentos (default false) para no resetear las filas existentes
        updateAllServiceSelects(); 
    });
    
    detallesContainer.addEventListener('change', (e) => { 
        if (e.target.matches('.servicio-select')) {
            const row = e.target.closest('.item-row-v2');
            row.dataset.servicioId = e.target.value; 
            loadServiceData(e.target, row.dataset.normaId, row.dataset.metodoId);
        }
        updateTotals();
    });

    detallesContainer.addEventListener('input', (e) => {
        if (e.target.matches('.cantidad-input, .precio-input, .und-input')) {
            updateTotals();
        }
    });
    
    detallesContainer.addEventListener('click', (e) => {
        const removeBtn = e.target.closest('.remove-item-btn');
        if (removeBtn) {
            removeBtn.closest('.item-row-v2').remove(); 
            updateTotals();
        }
    });

    cotizacionForm.addEventListener('submit', (e) => {
        updateTotals();
        if (!detallesJsonInput.value || JSON.parse(detallesJsonInput.value).length === 0) {
            e.preventDefault();
            alert('Debe agregar al menos un 铆tem a la cotizaci贸n.');
        }
    });

    // --- Inicializaci贸n General ---
    
    loadAllServicesData(); // 1. Cargar el JSON con todos los servicios

    // Inicializaci贸n de selects est谩ticos
    if (typeof TomSelect !== 'undefined') {
        initializeTomSelect(clientesSelect, {placeholder: 'Seleccione cliente'});
        initializeTomSelect(formaPagoSelect, {placeholder: 'Seleccione forma de pago'});
        //  Inicializamos la categor铆a y guardamos la instancia
        initializeTomSelect(categoriaServicioSelect, {placeholder: 'Seleccione categor铆a'}); 
    }

    // Cargar datos iniciales del cliente
    const initialSelectedOption = clientesSelect.options[clientesSelect.selectedIndex];
    if (initialSelectedOption && initialSelectedOption.value) {
        loadClientData(initialSelectedOption);
    }
    
    // Inicializaci贸n para filas existentes (Edici贸n)
    let initialRowsPresent = false;
    detallesContainer.querySelectorAll('.item-row-v2').forEach(row => {
        initialRowsPresent = true;
        
        const selectedServicioId = row.dataset.servicioId; 
        const selectedNormaId = row.dataset.normaId;
        const selectedMetodoId = row.dataset.metodoId;
        
        const servicioSelect = row.querySelector('.servicio-select');
        
        initializeTomSelect(servicioSelect); 
        
        if (selectedServicioId) {
            loadServiceData(servicioSelect, selectedNormaId, selectedMetodoId);
        }
    });

    // Asegurar que siempre haya una fila al inicio si est谩 vac铆o
    if (!initialRowsPresent) {
        addRow();
    }
    
    // Paso FINAL CRTICO: Poblar todos los selects de servicio con el filtro de la categor铆a inicial.
    updateAllServiceSelects(); 
});
</script>
{% endblock %}