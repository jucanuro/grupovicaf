{% extends 'base_vicafpro.html' %}
{% load static %}

{% block title %}VICAFPRO - Panel de Control{% endblock %}

{% block content %}

<div id="inicio-content">
    <header id="main-header" class="flex justify-between items-center mb-10 animate-fade-in-up">
        <div>
            <h1 class="text-xl font-extrabold">Panel de Control</h1>
            <p class="text-slate-400 mt-3">Hola, {{ user.get_full_name|default:user.username }}. Bienvenido al futuro de la gesti√≥n.</p>
        </div>
    </header>
    <div id="card-container" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
    </div>
</div>

<div id="analisis-content" class="hidden">
</div>

<style>
    :root {
        --vicaf-primary: #3b82f6;
        /* Fondo m√°s s√≥lido para mejorar contraste de texto */
        --vicaf-soft-bg: rgba(255, 255, 255, 0.98); 
    }

    .glass-modal-vicaf {
        background: var(--vicaf-soft-bg);
        backdrop-filter: blur(25px) saturate(200%);
        border: 1px solid rgba(255, 255, 255, 0.8);
        box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.25);
        width: auto; 
        max-width: 95vw;
        max-height: 85vh; 
        display: flex;
        flex-direction: column;
        border-radius: 32px;
        overflow: hidden;
    }

    /* T√≠tulos de Categor√≠a: M√°s n√≠tidos y con mejor espaciado */
    .category-label {
        text-[10px] font-black uppercase tracking-[0.25em];
        color: #64748b; /* Slate 500 para contraste sobre blanco */
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 12px;
    }

    #submenu-list {
        display: flex;
        flex-direction: row;
        gap: 3rem; /* M√°s espacio entre grupos para que no se vea amontonado */
        padding: 20px 32px; /* M√°s aire lateral */
        align-items: flex-start;
        overflow-x: auto; 
        scrollbar-width: thin;
        scrollbar-color: #3b82f6 transparent;
    }

    /* Columnas fijas para que el texto NO se rompa */
    #submenu-list > div {
        flex: 0 0 320px;
        display: flex;
        flex-direction: column;
    }

    /* TARJETAS: Estilo "Apple" ultra limpio */
    .submenu-item {
        background: #ffffff;
        border: 1px solid #f1f5f9;
        border-radius: 20px;
        padding: 18px;
        margin-bottom: 10px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }

    .submenu-item:hover {
        background: #ffffff;
        border-color: var(--vicaf-primary);
        transform: translateY(-3px) scale(1.02);
        box-shadow: 0 12px 20px -5px rgba(59, 130, 246, 0.15);
    }

    /* Textos dentro de la tarjeta: FUERTE CONTRASTE */
    .item-title {
        color: #0f172a; /* Casi negro para legibilidad total */
        font-weight: 800;
        font-size: 0.85rem;
        letter-spacing: -0.01em;
    }

    .item-desc {
        color: #64748b; /* Gris oscuro para la descripci√≥n */
        font-size: 11px;
        line-height: 1.4;
        margin-top: 2px;
    }

    /* Iconos con fondo vibrante */
    .item-icon-wrapper {
        width: 44px;
        height: 44px;
        background: #f8faff;
        border-radius: 14px;
        color: var(--vicaf-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        margin-right: 16px;
        transition: all 0.3s ease;
    }

    .submenu-item:hover .item-icon-wrapper {
        background: var(--vicaf-primary);
        color: white;
    }

    /* Personalizaci√≥n del Scrollbar para que sea profesional */
    #submenu-list::-webkit-scrollbar { height: 6px; }
    #submenu-list::-webkit-scrollbar-track { background: transparent; }
    #submenu-list::-webkit-scrollbar-thumb { 
        background: #e2e8f0; 
        border-radius: 10px; 
    }
    #submenu-list::-webkit-scrollbar-thumb:hover { background: #3b82f6; }
</style>
<div id="card-overlay"
    class="fixed inset-0 z-[999999] flex justify-center items-center bg-slate-900/40 backdrop-blur-md hidden transition-all duration-300">
    
    <div id="submenu-modal" 
         class="glass-modal-vicaf rounded-[32px] transform scale-95 opacity-0 transition-all duration-300">
        
        <header class="p-8 pb-4 flex justify-between items-center">
            <div>
                <span class="text-[10px] font-bold text-blue-600 uppercase tracking-widest bg-blue-50 px-3 py-1 rounded-full">Sistema de administraci√≥n VicafPro</span>
                <h3 id="submenu-title" class="text-2xl font-extrabold text-slate-800 mt-2 tracking-tight">Opciones</h3>
            </div>
            
            <button id="close-submenu" class="p-3 bg-slate-100 hover:bg-red-50 text-slate-400 hover:text-red-500 rounded-full transition-all">
                <i data-lucide="x" class="w-5 h-5"></i>
            </button>
        </header>

        <div class="p-8 pt-2 max-h-[70vh] overflow-y-auto custom-scrollbar">
            <ul id="submenu-list">
                </ul>
        </div>

        <footer class="px-8 py-5 bg-slate-50/50 border-t border-slate-100 flex justify-between items-center rounded-b-[32px]">
            <p class="text-[10px] text-slate-400 font-medium">¬© 2026 VICAFPRO Premium Resources</p>
            <div class="flex gap-2">
                <div class="w-2 h-2 bg-emerald-400 rounded-full animate-pulse"></div>
            </div>
        </footer>
    </div>
</div>

{% endblock %}

{% block extra_content %}
<div id="command-palette"
    class="fixed inset-0 z-50 flex justify-center items-start pt-20 bg-black/50 backdrop-blur-sm hidden">
    <div class="glass-card w-full max-w-xl rounded-2xl shadow-2xl overflow-hidden border-emerald-500/50">
        <input id="command-input" type="text" placeholder="Escribe un comando o busca una p√°gina..."
            class="w-full p-4 text-lg bg-transparent text-white focus:outline-none border-b border-slate-500/50">
        <ul id="command-list" class="p-2 max-h-96 overflow-y-auto"></ul>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- 1. DATA (Mantenemos toda tu informaci√≥n intacta) ---
        const navigationData = [
            {
                id: 'clientes',
                icon: 'üë•',
                category: 'Gesti√≥n',
                title: 'M√≥dulo de Clientes',
                desc: 'Administra y revisa la base de datos de clientes.',
                glow: '#0ea5e9',
                children: [
                    { id: 'lista_clientes', url: "{% url 'clientes:lista_clientes' %}", icon: 'üìã', title: 'Listado de Clientes', desc: 'Ver todos los clientes registrados.', category: 'Clientes' },
                    { id: 'crear_cliente', url: "{% url 'clientes:crear_cliente' %}", icon: '‚ûï', title: 'Crear Cliente', desc: 'Registrar un nuevo perfil de cliente.', category: 'Clientes' },
                ]
            },
            {
                id: 'servicios',
                icon: 'üîß',
                category: 'Gesti√≥n',
                title: 'M√≥dulo de Servicios',
                desc: 'Administra los servicios y las cotizaciones de la empresa.',
                glow: '#f59e0b',
                children: [
                    { id: 'servicios', url: "{% url 'servicios:lista_servicios' %}", icon: 'üìÉ', title: 'Listado de Servicios', desc: 'Ver el cat√°logo de servicios.', category: 'Servicios' },
                    { id: 'crear_servicio', url: "{% url 'servicios:crear_servicio' %}", icon: '‚ûï', title: 'Crear Servicio', desc: 'Registrar un nuevo servicio.', category: 'Servicios' },
                    { 
                        id: 'cotizaciones', 
                        icon: 'üí∏', 
                        title: 'Gesti√≥n de Cotizaciones', 
                        desc: 'Administra las cotizaciones de servicios.',
                        category: 'Cotizaciones',
                        children: [
                            { id: 'listar_cotizaciones', url: "{% url 'servicios:lista_servicios' %}", icon: 'üìã', title: 'Listar Cotizaciones', desc: 'Ver y gestionar las cotizaciones existentes.', category: 'Cotizaciones' },
                            { id: 'crear_cotizacion', url: "{% url 'servicios:lista_servicios' %}", icon: '‚ûï', title: 'Crear Cotizaci√≥n', desc: 'Generar una nueva oferta de servicio.', category: 'Cotizaciones' },
                        ]
                    },
                ]
            },
            {
                id: 'trabajadores',
                icon: 'üë®‚Äçüíº',
                category: 'Gesti√≥n',
                title: 'M√≥dulo de Trabajadores',
                desc: 'Gestiona la informaci√≥n y roles de los empleados.',
                glow: '#6366f1',
                children: [
                    { id: 'trabajador_list', url: "{% url 'trabajadores:lista_trabajadores' %}", icon: 'üë®‚Äçüëß‚Äçüë¶', title: 'Listado de Trabajadores', desc: 'Ver todos los trabajadores.', category: 'Trabajadores' },
                    { id: 'trabajador_create', url: "{% url 'trabajadores:crear_trabajador' %}", icon: '‚ûï', title: 'Crear Trabajador', desc: 'Registrar un nuevo empleado.', category: 'Trabajadores' },
                    { id: 'rol_list', url: "{% url 'trabajadores:lista_roles' %}", icon: 'üîê', title: 'Gesti√≥n de Roles', desc: 'Administrar los tipos de cargos.', category: 'Roles' },
                    { id: 'rol_create', url: "", icon: 'üõ°Ô∏è', title: 'Crear Nuevo Rol', desc: 'Definir un nuevo rol en el sistema.', category: 'Roles' },
                ]
            },
            {
                id: 'proyectos',
                icon: 'üìÅ',
                category: 'Operaciones',
                title: 'M√≥dulo de Proyectos',
                desc: 'Controla el progreso y los detalles de los proyectos.',
                glow: '#a855f7',
                children: [
                    {
                        id: 'gestion_proyectos',
                        icon: '‚úÖ',
                        title: 'Gesti√≥n de Proyectos',
                        desc: 'Administra los proyectos de la empresa.',
                        category: 'Proyectos',
                        children: [
                            { id: 'proyectos_list', url: "#", icon: 'üìã', title: 'Listar Proyectos', desc: 'Visualiza el estado de los proyectos.', category: 'Proyectos' },
                        ]
                    },
                    {
                        id: 'gestion_ordenes_ensayo',
                        icon: 'üìù',
                        title: 'Gesti√≥n de √ìrdenes de Ensayo',
                        desc: 'Gestiona las √≥rdenes de ensayo.',
                        category: '√ìrdenes de Ensayo',
                        children: [
                            { id: 'ordenes_ensayo_list', url: "#", icon: 'üìã', title: 'Listar √ìrdenes', desc: 'Ver y gestionar las √≥rdenes de ensayo existentes.', category: '√ìrdenes de Ensayo' },
                            { id: 'ordenes_ensayo_nuevo', url: "#", icon: '‚ûï', title: 'Nueva Orden', desc: 'Genera una nueva orden de ensayo.', category: '√ìrdenes de Ensayo' },
                        ]
                    },
                    {
                        id: 'gestion_muestras',
                        icon: 'üî¨',
                        title: 'Gesti√≥n de Muestras',
                        desc: 'Administra el registro de muestras.',
                        category: 'Muestras',
                        children: [
                            { id: 'muestras_list', url: "#", icon: 'üìã', title: 'Listar Muestras', desc: 'Ver las muestras registradas.', category: 'Muestras' },
                            { id: 'muestras_nuevo', url: "#", icon: '‚ûï', title: 'Nueva Muestra', desc: 'Registra una nueva muestra.', category: 'Muestras' },
                        ]
                    },
                    {
                        id: 'gestion_resultados',
                        icon: 'üìä',
                        title: 'Gesti√≥n de Resultados',
                        desc: 'Administra los resultados de los ensayos.',
                        category: 'Resultados',
                        children: [
                            { id: 'resultados_list', url: "#", icon: 'üìã', title: 'Listar Resultados', desc: 'Ver los resultados de ensayo.', category: 'Resultados' },
                            { id: 'resultados_nuevo', url: "#", icon: '‚ûï', title: 'Nuevo Resultado', desc: 'Registra un nuevo resultado.', category: 'Resultados' },
                        ]
                    },
                    {
                        id: 'gestion_documentos',
                        icon: 'üìÑ',
                        title: 'Gesti√≥n de Documentos',
                        desc: 'Administra los informes y documentos finales.',
                        category: 'Documentos',
                        children: [
                            { id: 'documentos_list', url: "#", icon: 'üìã', title: 'Listar Documentos', desc: 'Ver los documentos finales generados.', category: 'Documentos' },
                            { id: 'documentos_nuevo', url: "#", icon: '‚ûï', title: 'Nuevo Documento', desc: 'Sube un nuevo informe o documento final.', category: 'Documentos' },
                        ]
                    },
                ]
            },
            {
                id: 'bolsa_trabajo',
                icon: 'üíº',
                category: 'RR.HH.',
                title: 'Bolsa de Trabajo',
                desc: 'Gestiona las candidaturas y ofertas de empleo.',
                glow: '#3b82f6',
                url: "#"
            },
            {
                id: 'analisis',
                url: '#',
                icon: 'üìä',
                category: 'An√°lisis',
                title: 'Dashboard de An√°lisis',
                desc: 'M√©tricas y KPIs de tus proyectos.',
                glow: '#ef4444',
                action: 'show_analysis_view',
                isLight: false 
            },
        ];

        // --- 2. CONFIGURACI√ìN DE ELEMENTOS ---
        const cardContainer = document.getElementById('card-container');
        const inicioContent = document.getElementById('inicio-content');
        const analisisContent = document.getElementById('analisis-content');
        const cardOverlay = document.getElementById('card-overlay');
        const submenuModal = document.getElementById('submenu-modal');
        const submenuTitle = document.getElementById('submenu-title');
        const submenuList = document.getElementById('submenu-list');
        const closeSubmenuButton = document.getElementById('close-submenu');
        const commandPalette = document.getElementById('command-palette');
        const commandInput = document.getElementById('command-input');
        const commandList = document.getElementById('command-list');
        const commandButtons = document.querySelectorAll('#command-palette-button-main');
        let selectedIndex = 0;

        // Fondo Geom√©trico (Mantenido)
        document.body.style.backgroundColor = '#ffffff';
        document.body.style.backgroundImage = `
            radial-gradient(#e5e7eb 1px, transparent 1px),
            linear-gradient(to right, #f3f4f6 1px, transparent 1px),
            linear-gradient(to bottom, #f3f4f6 1px, transparent 1px)
        `;
        document.body.style.backgroundSize = '20px 20px, 100px 100px, 100px 100px';

        // --- 3. FUNCIONES DE CONTROL ---
        const setActiveView = (viewName) => {
            const isInicio = viewName === 'inicio';
            inicioContent.classList.toggle('hidden', !isInicio);
            analisisContent.classList.toggle('hidden', isInicio);
        };
        
        const closeSubmenuModal = () => {
            submenuModal.classList.remove('scale-100', 'opacity-100');
            submenuModal.classList.add('scale-95', 'opacity-0');
            setTimeout(() => { cardOverlay.classList.add('hidden'); }, 300);
        };

        const openCommandPalette = () => { 
            if (commandPalette && commandInput) {
                commandPalette.classList.remove('hidden'); 
                commandInput.focus(); 
                renderCommandList(commands); 
            }
        };
        
        const closeCommandPalette = () => { 
            if (commandPalette && commandInput) {
                commandPalette.classList.add('hidden'); 
                commandInput.value = ''; 
            }
        };

        // --- 4. RENDERIZADO DE CARDS PRINCIPALES (Mantenido) ---
        const renderCards = (items) => {
            cardContainer.innerHTML = '';
            const pyramidShape = "polygon(15% 0%, 85% 0%, 100% 80%, 50% 100%, 0% 80%)";

            items.forEach((card) => {
                const cardElement = document.createElement('a');
                cardElement.className = `relative group cursor-pointer animate-fade-in-up h-56 w-full flex flex-col items-center justify-center transition-all duration-300 hover:-translate-y-2`;
                cardElement.href = card.url || '#';

                cardElement.innerHTML = `
                    <div class="absolute inset-0 bg-white border border-slate-200 shadow-sm transition-all duration-500 group-hover:shadow-md" style="clip-path: ${pyramidShape};"></div>
                    <div class="relative z-10 flex flex-col items-center px-4 text-center -mt-2">
                        <div class="text-3xl mb-2 transition-transform group-hover:scale-110">${card.icon}</div>
                        <span class="text-[8px] font-bold uppercase tracking-widest text-slate-400 mb-1">${card.category}</span>
                        <h4 class="text-xs font-black text-slate-800 leading-tight">${card.title}</h4>
                        <div class="mt-2 w-6 h-[2px] rounded-full transition-all duration-500 group-hover:w-12" style="background: ${card.glow}"></div>
                    </div>
                `;

                cardElement.addEventListener('click', (e) => {
                    if (card.children && card.children.length > 0) {
                        e.preventDefault();
                        renderSubmenu(card);
                    } else if (card.action === 'show_analysis_view') {
                        e.preventDefault();
                        setActiveView('analisis');
                    }
                });
                cardContainer.appendChild(cardElement);
            });
        };

        // --- 5. RENDERIZADO DE SUBMEN√ö (Ajustado para flujo lateral) ---
        // --- RENDERIZADO PROFESIONAL: DIN√ÅMICO, LATERAL Y AUTO-AJUSTABLE ---
        const renderSubmenu = (parentCard) => {
            submenuTitle.textContent = parentCard.title;
            submenuTitle.style.color = parentCard.glow;
            
            // 1. Limpieza total y configuraci√≥n de flex horizontal
            submenuList.innerHTML = ''; 
            // 'w-fit' es la clave: el contenedor medir√° solo lo que midan sus hijos
            // Aseg√∫rate de que esta l√≠nea quede as√≠:
            submenuList.className = "flex flex-row gap-10 p-2 items-start justify-start w-max";
            // 2. Reset del Modal (Libertad total de crecimiento)
            submenuModal.style.width = 'auto'; 
            submenuModal.style.height = 'auto';
            submenuModal.style.minWidth = '380px';
            submenuModal.style.maxWidth = '92vw'; // Margen de seguridad lateral
            
            // Limitamos el alto a la zona segura entre cabecera y pie
            submenuModal.style.maxHeight = '85vh'; 
            // SOLO un scroll, y solo si es estrictamente necesario por altura
            submenuModal.style.overflowY = 'auto'; 
            submenuModal.style.overflowX = 'hidden'; 

            // 3. Agrupamiento inteligente
            const grouped = parentCard.children.reduce((acc, child) => {
                const cat = child.category || 'Opciones';
                if (!acc[cat]) acc[cat] = [];
                acc[cat].push(child);
                return acc;
            }, {});

            // 4. Creaci√≥n de Columnas Din√°micas
            Object.keys(grouped).forEach(catName => {
                const column = document.createElement('div');
                // 'flex-shrink-0' evita que las columnas se aplasten cuando el modal crece
                column.className = "flex flex-col gap-4 min-w-[320px] flex-shrink-0 mb-4";

                const label = document.createElement('h4');
                label.className = "text-[10px] font-black uppercase tracking-[0.3em] text-slate-400 mb-2 flex items-center gap-3";
                label.innerHTML = `<span class="w-6 h-[1.5px]" style="background: ${parentCard.glow}44"></span>${catName}`;
                column.appendChild(label);

                const itemsWrapper = document.createElement('div');
                itemsWrapper.className = "flex flex-col gap-3";

                grouped[catName].forEach(item => {
                    // Soporte para niveles profundos de datos
                    const subItems = (item.children && item.children.length > 0) ? item.children : [item];
                    
                    subItems.forEach(subItem => {
                        const card = document.createElement('a');
                        card.href = subItem.url || '#';
                        card.className = "submenu-item group w-full flex items-center p-4 rounded-2xl transition-all duration-300 hover:bg-white hover:shadow-lg border border-transparent hover:border-slate-100";
                        
                        card.innerHTML = `
                            <div class="item-icon-wrapper flex-shrink-0 w-10 h-10 flex items-center justify-center rounded-xl bg-slate-50 group-hover:bg-white transition-colors">
                                <span class="text-xl">${subItem.icon}</span>
                            </div>
                            <div class="flex flex-col text-left ml-4 overflow-hidden pr-2">
                                <span class="text-slate-800 font-bold text-[13px] leading-none mb-1">${subItem.title}</span>
                                <span class="text-[10px] text-slate-400 font-medium leading-tight line-clamp-2">${subItem.desc || ''}</span>
                            </div>
                            <div class="ml-auto opacity-0 group-hover:opacity-100 -translate-x-2 group-hover:translate-x-0 transition-all">
                                <i data-lucide="chevron-right" class="w-4 h-4 text-slate-400"></i>
                            </div>
                        `;
                        
                        card.addEventListener('click', (e) => {
                            if (subItem.url && subItem.url !== '#') closeSubmenuModal();
                            else e.preventDefault();
                        });

                        itemsWrapper.appendChild(card);
                    });
                });

                column.appendChild(itemsWrapper);
                submenuList.appendChild(column);
            });

            // 5. Animaci√≥n de entrada limpia
            cardOverlay.classList.remove('hidden');
            // Ajuste fino de Lucide
            if (window.lucide) lucide.createIcons();
            
            setTimeout(() => {
                submenuModal.classList.remove('scale-95', 'opacity-0');
                submenuModal.classList.add('scale-100', 'opacity-100');
            }, 10);
        };
        // --- 6. DASHBOARD DE AN√ÅLISIS (Mantenido) ---
        const renderAnalysisDashboard = () => {
            analisisContent.innerHTML = `
                <header class="flex justify-between items-center mb-6">
                    <h1 class="text-2xl font-black text-slate-800">An√°lisis Operativo</h1>
                    <button id="back-from-analysis" class="text-xs px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 transition-colors">Volver al Inicio</button>
                </header>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white border border-slate-100 p-6 rounded-2xl shadow-sm">
                        <div class="text-[10px] text-slate-400 font-bold uppercase mb-1">Status Global</div>
                        <div class="text-emerald-500 font-black text-xl">SISTEMA ONLINE</div>
                    </div>
                </div>
            `;
            document.getElementById('back-from-analysis').addEventListener('click', () => setActiveView('inicio'));
        };

        // --- 7. L√ìGICA DE COMANDOS (Mantenido) ---
        const commandItems = [];
        const processItems = (items) => {
            items.forEach(item => {
                if (item.children && item.children.length > 0) processItems(item.children);
                else commandItems.push(item);
            });
        };
        processItems(navigationData);

        const commands = [
            ...commandItems.map(card => ({
                name: card.title, category: card.category || 'M√≥dulo',
                action: () => {
                    if (card.action === 'show_analysis_view') setActiveView('analisis');
                    else window.location.href = card.url;
                }
            })),
            { name: 'Cerrar Sesi√≥n', category: 'Sistema', action: () => { console.log('Logout'); } }
        ];

        const renderCommandList = (items) => {
            commandList.innerHTML = '';
            if (items.length === 0) {
                commandList.innerHTML = `<li class="p-4 text-slate-400 text-center text-xs">Sin coincidencias detectadas.</li>`;
                return;
            }
            items.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = `p-3 flex justify-between rounded-lg cursor-pointer text-xs ${index === selectedIndex ? 'bg-blue-600 text-white' : 'hover:bg-slate-50 text-slate-600'}`;
                li.innerHTML = `<span>${item.name}</span> <span class="opacity-60 text-[9px] uppercase font-bold">${item.category}</span>`;
                li.addEventListener('click', () => { item.action(); closeCommandPalette(); });
                commandList.appendChild(li);
            });
        };

        const navigateCommands = (direction) => {
            const query = commandInput.value.toLowerCase();
            const filtered = commands.filter(c => c.name.toLowerCase().includes(query) || c.category.toLowerCase().includes(query));
            if (filtered.length === 0) return;

            if (direction === 'down') selectedIndex = (selectedIndex + 1) % filtered.length;
            else if (direction === 'up') selectedIndex = (selectedIndex - 1 + filtered.length) % filtered.length;
            else if (direction === 'enter') { filtered[selectedIndex].action(); closeCommandPalette(); return; }
            renderCommandList(filtered);
        };

        // --- 8. EVENT LISTENERS ---
        renderCards(navigationData);
        renderAnalysisDashboard();
        setActiveView('inicio');

        commandButtons.forEach(btn => btn.addEventListener('click', openCommandPalette));
        if (commandInput) {
            commandInput.addEventListener('input', () => {
                selectedIndex = 0;
                const query = commandInput.value.toLowerCase();
                renderCommandList(commands.filter(c => c.name.toLowerCase().includes(query) || c.category.toLowerCase().includes(query)));
            });
        }
        
        closeSubmenuButton.addEventListener('click', closeSubmenuModal);
        cardOverlay.addEventListener('click', (e) => { if (e.target === cardOverlay) closeSubmenuModal(); });

        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') { closeSubmenuModal(); closeCommandPalette(); }
            if ((e.metaKey || e.ctrlKey) && e.key === 'k') { 
                e.preventDefault(); 
                commandPalette.classList.contains('hidden') ? openCommandPalette() : closeCommandPalette(); 
            }
            if (!commandPalette.classList.contains('hidden')) {
                if (e.key === 'ArrowDown') { e.preventDefault(); navigateCommands('down'); }
                else if (e.key === 'ArrowUp') { e.preventDefault(); navigateCommands('up'); }
                else if (e.key === 'Enter') { e.preventDefault(); navigateCommands('enter'); }
            }
        });
    });
</script>
{% endblock %}