{% extends 'base_vicafpro.html' %}

{% block content %}
<style>
    /* El degradado animado se mantiene como elemento de dise√±o "Alto Top" */
    .animated-gradient-text {
        background: linear-gradient(to right, #10B981, #3B82F6, #8B5CF6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-fill-color: transparent;
        background-size: 200% auto;
        animation: text-gradient 3s linear infinite alternate;
    }

    @keyframes text-gradient {
        to {
            background-position: 200% center;
        }
    }
</style>
<div class="p-4 md:p-6">
    <div class="border-b border-gray-200 pb-4 mb-6">
        <header class="flex flex-col md:flex-row items-start md:items-center justify-between gap-6 animate-fade-in-up">
            <h1 class="flex text-xl font-extrabold animated-gradient-text">
                Gesti√≥n de solicitudes de ensayo
                <svg class="h-6 w-6 ml-4 fill-indigo-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M184.6 475.5C181.5 482.8 179.2 490.4 177.8 498.1C163.3 506.9 146.3 512 128 512C75 512 32 469 32 416L32 128C14.3 128 0 113.7 0 96C0 78.3 14.3 64 32 64L224 64C241.7 64 256 78.3 256 96C256 113.7 241.7 128 224 128L224 383.6L184.6 475.5zM96 128L96 256L160 256L160 128L96 128zM352 64L512 64C529.7 64 544 78.3 544 96C544 113.7 529.7 128 512 128L512 281.4L603.3 494.4C605.6 499.8 607.1 505.5 607.7 511.4L608 512L607.7 512C607.9 513.8 608 515.6 608 517.4C608 549.7 581.8 576 549.4 576L282.5 576C250.2 576 223.9 549.8 223.9 517.4C223.9 515.6 224 513.8 224.2 512L223.9 512L224.2 511.4C224.8 505.6 226.3 499.8 228.6 494.4L320 281.4L320 128C302.3 128 288 113.7 288 96C288 78.3 302.3 64 320 64L352 64zM453.2 306.6C449.8 298.6 448 290.1 448 281.4L448 128L384 128L384 281.4C384 290.1 382.2 298.6 378.8 306.6L345.6 384L486.3 384L453.1 306.6z"/></svg>
            </h1>
            <a href="{% url 'proyectos:lista_proyectos_pendientes' %}" class="inline-flex items-center gap-2 px-6 py-2 bg-indigo-600 text-white font-semibold rounded-full hover:bg-indigo-700 transition-all duration-300 transform hover:scale-105 shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" data-lucide="list" class="lucide lucide-list w-5 h-5"><path d="M3 5h.01"></path><path d="M3 12h.01"></path><path d="M3 19h.01"></path><path d="M8 5h13"></path><path d="M8 12h13"></path><path d="M8 19h13"></path></svg>
                Regresar a Lista
            </a>
        </header>
    </div>
    <div class="container w-full max-w-full mx-auto py-4 overflow-y-auto max-h-full">
        <div class="bg-white shadow-2xl rounded-xl p-6 md:p-8 text-gray-800 border border-gray-100">
            <h1 class="text-md font-bold text-gray-800 border-l-4 border-indigo-500 pl-3 mb-2">
                {% if solicitud %}Edici√≥n{% else %}Creaci√≥n{% endif %} de Solicitud de Ensayo
            </h1>
            <p class="text-md text-gray-600 font-medium mb-6 ml-3">
                Muestra: <strong class="text-indigo-600">{{ muestra.codigo_muestra }}</strong> | Proyecto: <strong class="text-indigo-600">{{ muestra.proyecto.codigo_proyecto }}</strong>
            </p>
            
            {% if solicitud_ya_detallada %}
            <div class="p-4 mb-4 text-sm text-red-700 bg-red-100 rounded-lg border-l-4 border-red-500" role="alert">
                <span class="font-bold">‚ö†Ô∏è Atenci√≥n:</span> La Solicitud **{{ solicitud.codigo_solicitud }}** ya fue detallada (aprobada/enviada a Lab). Esta vista es de **solo lectura** y no se puede modificar.
            </div>
            {% endif %}

            {# Formulario principal #}
            <form id="solicitud-form" method="POST" action="." onsubmit="return false;" 
                data-list-url="{% url 'proyectos:lista_solicitudes_ensayo_por_muestra' muestra.pk %}">
                {% csrf_token %}
                <input type="hidden" id="solicitud-id" value="{{ solicitud.id|default:'' }}">
                <input type="hidden" id="muestra-id" value="{{ muestra.id }}">

                {# FIELDSET 1: Datos de Cabecera #}
                <fieldset class="border border-gray-300 p-6 rounded-lg mb-8 bg-gray-50" {% if solicitud_ya_detallada %}disabled{% endif %}>
                    <legend class="px-3 text-md font-semibold text-indigo-600">1. Datos de Cabecera (Solicitud)</legend>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        {# C√≥digo Solicitud (Readonly) - Oculto #}
                        <div class="hidden">
                            <label for="codigo_solicitud" class="block text-sm font-medium text-gray-600 mb-1">C√≥digo de Solicitud:</label>
                            <input type="text" id="codigo_solicitud" 
                                value="{{ solicitud.codigo_solicitud|default:'GENERADO AUTOM√ÅTICAMENTE' }}" 
                                readonly 
                                class="w-full p-2.5 rounded-lg bg-gray-200 border border-gray-300 text-gray-500 cursor-not-allowed">
                        </div>
                        
                        {# Generada Por (Select) #}
                        <div>
                            <label for="generada_por_id" class="block text-sm font-medium text-gray-700 mb-1">Generada Por (T√©cnico/Jefe) *:</label>
                            <select id="generada_por_id" name="generada_por_id" required
                                class="w-full p-2.5 rounded-lg bg-white border border-gray-300 text-gray-900 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                                <option value="" class="bg-white">Seleccione Usuario</option>
                                {% for tecnico in tecnicos %}
                                <option value="{{ tecnico.id }}" class="bg-white"
                                    {% if solicitud.generada_por_id == tecnico.id %}
                                        selected
                                    {% elif not solicitud.id and request.user.trabajadorprofile.id == tecnico.id %}
                                        selected
                                    {% endif %}
                                >
                                    {{ tecnico.nombre_completo }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div>
                            <label for="fecha_entrega_programada" class="block text-sm font-medium text-gray-700 mb-1">Fecha L√≠mite Solicitud (Global):</label>
                            <input type="date" id="fecha_entrega_programada" name="fecha_entrega_programada" 
                                value="{{ solicitud.fecha_entrega_programada|date:'Y-m-d'|default:'' }}"
                                class="w-full p-2.5 rounded-lg bg-white border border-gray-300 text-gray-900 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm">
                        </div>
                    </div>
                </fieldset>

                {# FIELDSET 2: Detalle de Ensayos #}
                <fieldset class="border border-gray-300 p-6 rounded-lg mb-8 bg-gray-50" {% if solicitud_ya_detallada %}disabled{% endif %}>
                    <legend class="px-3 text-md font-semibold text-indigo-600">2. Detalle de Ensayos (Tareas de Ejecuci√≥n)</legend>
                    
                    <button type="button" onclick="agregarDetalle()" 
                        class="px-4 py-2 text-sm bg-green-600 text-white font-semibold rounded-lg shadow hover:bg-green-700 transition duration-150 mb-4 flex items-center transform hover:scale-[1.01]">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                        </svg>
                        A√±adir Tarea Manual
                    </button>
                    
                    <div id="detalles-container" class="space-y-6">
                        {# Detalles se insertan aqu√≠ con JS #}
                    </div>
                    
                    {# Mensaje de vac√≠o #}
                    <p id="detalle-vacio-msg" class="text-gray-500 italic mt-4 text-center hidden p-4 border border-dashed border-gray-300 rounded-lg bg-white">
                        No hay tareas de ensayo. Haga clic en "A√±adir Tarea Manual".
                    </p>
                </fieldset>

                <div class="mt-8 flex items-center justify-end gap-4"> 
    
                    {# Spinner y mensajes de respuesta (Mu√©velos a la izquierda del bot√≥n para el flujo visual) #}
                    <span id="loading-spinner" class="text-indigo-600 font-semibold hidden flex items-center order-1">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Procesando...
                    </span>
                    
                    <div id="response-message" class="mt-2 order-2"></div>

                    {# Bot√≥n Guardar (Ahora a la derecha) #}
                    <button type="button" onclick="guardarSolicitud()" id="submit-button" 
                        class="px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg shadow-xl hover:bg-indigo-700 transition duration-150 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center transform hover:scale-[1.02] order-3" 
                        {% if solicitud_ya_detallada %}disabled{% endif %}>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor">
                            <path d="M7 3a1 1 0 000 2h6a1 1 0 100-2H7z" />
                            <path fill-rule="evenodd" d="M12 2H8a2 2 0 00-2 2v1H4a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V7a2 2 0 00-2-2h-2V4a2 2 0 00-2-2zM5 9h10a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6a1 1 0 011-1z" clip-rule="evenodd" />
                            <path fill-rule="evenodd" d="M10 13a1 1 0 100 2h.01a1 1 0 100-2H10z" clip-rule="evenodd" />
                        </svg>
                        Guardar Solicitud a Laboratorio
                    </button>
                </div>

            </form>
        </div>
    </div>
    
    {# JSON DATA SCRIPTS (Sin cambios) #}
    {{ tipos_ensayo | default_if_none:"[]" | json_script:"tipos-ensayo-data" }}
    {{ tecnicos | default_if_none:"[]" | json_script:"tecnicos-data" }}
    {{ normas | default_if_none:"[]" | json_script:"normas-data" }}
    {{ metodos | default_if_none:"[]" | json_script:"metodos-data" }}
    
    {% if detalles_existentes %}
        <script id="existentes-data" type="application/json">
            [
            {% for detalle in detalles_existentes %}
                { 
                    "pk": {{ detalle.id }}, 
                    "descripcion": "{{ detalle.tipo_ensayo_descripcion|escapejs }}",
                    "norma_id": {{ detalle.norma_id|default:"null" }},
                    "metodo_id": {{ detalle.metodo_id|default:"null" }},
                    "fecha_limite": "{{ detalle.fecha_limite_ejecucion|date:'Y-m-d' }}",
                    "cotizacion_detalle_id": {{ detalle.detalle_cotizacion_id|default:"null" }},
                    "observaciones_detalle": "{{ detalle.observaciones_detalle|escapejs|default:"" }}",
                    "cantidad": {{ detalle.cantidad|default:1 }},
                    "asignaciones": [
                        {% for asignacion in detalle.asignaciones.all %}
                            { 
                                "tipo_ensayo_id": {{ asignacion.tipo_ensayo_id }}, 
                                "tecnico_id": {{ asignacion.tecnico_asignado_id }} 
                            }{% if not forloop.last %},{% endif %}
                        {% endfor %}
                    ]
                }{% if not forloop.last %},{% endif %}
            {% endfor %}
            ]
        </script>
    {% else %}
        <script id="existentes-data" type="application/json">[]</script>
    {% endif %}

<script>
// ====================================================================
// 0. CARGA Y DATOS GLOBALES (Sin cambios)
// ====================================================================

function safeParseJson(id) {
    try {
        const el = document.getElementById(id);
        return el ? JSON.parse(el.textContent) : [];
    } catch (e) {
        console.error(`Error al parsear JSON para ${id}:`, e);
        return [];
    }
}

// Variables de datos globales (se asume que se definen en el HTML como JSON)
const tecnicosData = safeParseJson('tecnicos-data');
const tiposEnsayoData = safeParseJson('tipos-ensayo-data');
const normasData = safeParseJson('normas-data');
const metodosData = safeParseJson('metodos-data');

let detalleIndex = 0; 

// ====================================================================
// 1. FUNCIONES AUXILIARES DE RENDERIZADO (Dise√±o Tailwind Adaptado a BLANCO)
// ====================================================================

function renderSelect(name, data, selectedId, labelText, required = false) {
    const reqAttr = required ? 'required' : '';
    // INVERSI√ìN: bg-white, border-gray-300, text-gray-900
    const selectClasses = 'w-full p-2.5 rounded-lg bg-white border border-gray-300 text-gray-900 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm';
    // INVERSI√ìN: text-gray-700
    const labelClasses = 'block text-sm font-medium text-gray-700 mb-1'; 
    
    let options = `<option value="" class="bg-white">Seleccione ${labelText}</option>`;
    
    const selectedIdStr = selectedId ? String(selectedId) : '';

    data.forEach(item => {
        const itemIdStr = String(item.id); 
        const selected = itemIdStr === selectedIdStr ? 'selected' : '';
        // Prioridad: codigo > nombre_completo > nombre
        const display = item.codigo ? `${item.nombre} (${item.codigo})` : item.nombre_completo || item.nombre;
        // INVERSI√ìN: bg-white
        options += `<option value="${itemIdStr}" ${selected} class="bg-white">${display}</option>`;
    });

    return `
        <label class="${labelClasses}">${labelText}:</label>
        <select name="${name}" class="${selectClasses}" ${reqAttr}>${options}</select>
    `;
}

// ====================================================================
// 2. MANEJO DE ASIGNACIONES (ANIDADAS) (Dise√±o Tailwind Adaptado a BLANCO)
// ====================================================================

function agregarAsignacion(detalleIdx, asignacion = {}) {
    const container = document.getElementById(`asignaciones-container-${detalleIdx}`);
    if (!container) return;
    
    const id = `asignacion-${detalleIdx}-${Date.now()}-${container.children.length}`; 
    
    const div = document.createElement('div');
    div.id = id;
    // INVERSI√ìN: border-gray-300, bg-white
    div.className = 'p-3 mt-3 border border-dashed border-gray-300 bg-white rounded-lg relative shadow-sm'; 
    
    // Se utiliza renderSelect, que ya fue ajustado
    const tipoEnsayoSelect = renderSelect('tipo_ensayo_id', tiposEnsayoData, asignacion.tipo_ensayo_id, 'Tipo Ensayo *', true);
    const tecnicoSelect = renderSelect('tecnico_id', tecnicosData, asignacion.tecnico_id, 'T√©cnico Asignado *', true);
    
    div.innerHTML = `
        <input type="hidden" name="asignacion_pk" value="${asignacion.pk || ''}">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div class="-mt-3">${tipoEnsayoSelect}</div>
            <div class="-mt-3">${tecnicoSelect}</div>
        </div>
        <button type="button" onclick="removerAsignacion('${id}')" 
                class="absolute top-0 right-0 m-2 text-red-500 hover:text-red-700 transition duration-150" 
                title="Remover Asignaci√≥n">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" />
            </svg>
        </button>
    `;
    container.appendChild(div);
}

function removerAsignacion(id) {
    document.getElementById(id)?.remove();
}

// ====================================================================
// 3. MANEJO DE DETALLES (PRINCIPALES) (Dise√±o Tailwind Adaptado a BLANCO)
// ====================================================================

function agregarDetalle(detalle = {}) {
    const container = document.getElementById('detalles-container');
    const msg = document.getElementById('detalle-vacio-msg');
    if (msg) msg.classList.add('hidden'); // Ocultar mensaje de vac√≠o

    const idx = detalleIndex++;
    const id = `detalle-card-${idx}`;
    
    const div = document.createElement('div');
    div.id = id;
    // INVERSI√ìN: bg-gray-100, border-indigo-300
    div.className = 'p-6 bg-gray-100 border border-indigo-300 rounded-xl relative shadow-lg detalle-card';
    div.setAttribute('data-index', idx);
    if (detalle.pk) div.setAttribute('data-pk', detalle.pk);
    
    // Se utiliza renderSelect, que ya fue ajustado para ser compacto
    const normaSelect = renderSelect('norma', normasData, detalle.norma_id, 'Norma Aplicable');
    const metodoSelect = renderSelect('metodo', metodosData, detalle.metodo_id, 'M√©todo Aplicable');
    
    const descripcionSegura = (detalle.descripcion || '').replace(/"/g, '&quot;');
    const observacionesSeguras = (detalle.observaciones_detalle || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    const fechaLimite = detalle.fecha_limite || '';

    // INVERSI√ìN: bg-white, border-gray-300, text-gray-900
    const inputClasses = 'w-full p-2.5 rounded-lg bg-white border border-gray-300 text-gray-900 focus:ring-indigo-500 focus:border-indigo-500 shadow-sm';
    // INVERSI√ìN: text-gray-700
    const labelClasses = 'block text-sm font-medium text-gray-700 mb-1';

    div.innerHTML = `
        <div class="flex justify-between items-center border-b border-gray-200 pb-3 mb-4">
            <h3 class="text-xl font-semibold text-indigo-600">Tarea #${idx + 1} ${detalle.pk ? `<span class="text-sm text-gray-500 ml-2">(ID: ${detalle.pk})</span>` : ''}</h3>
            <button type="button" onclick="removerDetalle(${idx})" 
                    class="text-red-500 hover:text-red-700 transition duration-150 p-1" 
                    title="Remover Tarea">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
            </button>
        </div>

        <input type="hidden" name="detalle_pk" value="${detalle.pk || ''}">
        <input type="hidden" name="cotizacion_detalle_id" value="${detalle.cotizacion_detalle_id || ''}">

        
        {# ESTRUCTURA DE 4 COLUMNAS: DOS FILAS DE CAMPOS PRINCIPALES #}
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            
            {# FILA 1: CUATRO CAMPOS PEQUE√ëOS #}
            
            {# 1. FECHA L√çMITE (1 columna) #}
            <div>
                <label class="${labelClasses}">Fecha L√≠mite *:</label>
                <input type="date" name="fecha_limite" value="${fechaLimite}" required class="${inputClasses}">
            </div>
            
            {# 2. NORMA APLICABLE (1 columna) #}
            <div>
                ${normaSelect}
            </div>
            
            {# 3. M√âTODO APLICABLE (1 columna) #}
            <div>
                ${metodoSelect}
            </div>

            {# 4. CANTIDAD (1 columna) #}
            <div>
                <label class="${labelClasses}">Cantidad *:</label>
                <input type="number" name="cantidad" value="${detalle.cantidad || 1}" required min="1" class="${inputClasses}">
            </div>
            
            {# FILA 2: UN CAMPO GRANDE #}

            {# 5. DESCRIPCI√ìN (4 columnas - Ocupa todo el ancho en una nueva fila) #}
            <div class="lg:col-span-4 mt-2">
                <label class="${labelClasses}">Descripci√≥n de la Tarea *:</label>
                <input type="text" name="descripcion" value="${descripcionSegura}" required class="${inputClasses}">
            </div>
        </div>
        
        {# OBSERVACIONES (Ancho completo) #}
        <div class="mt-4">
            <label class="${labelClasses}">Observaciones del Detalle:</label>
            <textarea name="observaciones_detalle" rows="2" class="${inputClasses} resize-none">${observacionesSeguras}</textarea>
        </div>

        {# Fieldset Anidado: Asignaciones #}
        <fieldset class="border border-gray-300 p-4 rounded-lg mt-6 bg-white">
            <legend class="px-3 text-sm font-semibold text-gray-700">Asignaci√≥n de Ensayos por T√©cnico</legend>
            
            <button type="button" onclick="agregarAsignacion(${idx})" 
                class="px-3 py-1 bg-indigo-600 text-white font-semibold rounded-lg shadow hover:bg-indigo-700 transition duration-150 text-sm flex items-center mb-3 transform hover:scale-[1.01]">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                A√±adir Tipo/T√©cnico
            </button>
            <div id="asignaciones-container-${idx}" class="asignaciones-scroll-area space-y-3"></div>
        </fieldset>
    `;

    container.appendChild(div);
    
    // L√≥gica para cargar asignaciones existentes o a√±adir una por defecto
    if (detalle.asignaciones && detalle.asignaciones.length > 0) {
        detalle.asignaciones.forEach(a => agregarAsignacion(idx, a));
    } else if (!detalle.pk && !document.querySelector('fieldset[disabled]')) {
        // Solo a√±adir una asignaci√≥n por defecto si no es una edici√≥n de solo lectura
        agregarAsignacion(idx, {});
    }
}

function removerDetalle(idx) {
    document.getElementById(`detalle-card-${idx}`)?.remove();
    
    const container = document.getElementById('detalles-container');
    if (container.children.length === 0) {
        const msg = document.getElementById('detalle-vacio-msg');
        if (msg) msg.classList.remove('hidden');
    }
}

// ====================================================================
// 4. MANEJO DE DATOS Y L√ìGICA DE GUARDADO (Mensajes de Feedback Adaptados)
// ====================================================================

function cargarDetallesExistentes() {
    const detalles = safeParseJson('existentes-data');
    if (detalles.length > 0) {
        detalles.forEach(detalle => agregarDetalle(detalle));
    } else {
        const msg = document.getElementById('detalle-vacio-msg');
        if (msg) msg.classList.remove('hidden');
    }
}

function colectarYValidarDatos(form) {
    const detalles = [];
    let isValid = true;
    let firstInvalidCard = null; 

    const detalleCards = document.querySelectorAll('.detalle-card');
    if (detalleCards.length === 0) {
        alert('Debe a√±adir al menos una Tarea de Ensayo (Detalle) para la solicitud.');
        return null;
    }

    detalleCards.forEach(card => {
        if (!isValid) return;

        const descripcionInput = card.querySelector('input[name="descripcion"]');
        const fechaLimiteInput = card.querySelector('input[name="fecha_limite"]');
        const cantidadInput = card.querySelector('input[name="cantidad"]'); // Nuevo campo
        const detalleIdx = card.getAttribute('data-index');

        if (!descripcionInput.value.trim() || !fechaLimiteInput.value || !cantidadInput.value || parseInt(cantidadInput.value) < 1) {
            alert(`Por favor, complete la Descripci√≥n, la Fecha L√≠mite y la Cantidad (m√≠n. 1) en la Tarea #${parseInt(detalleIdx) + 1}.`);
            isValid = false;
            firstInvalidCard = card;
            return;
        }

        const asignacionesContainer = document.getElementById(`asignaciones-container-${detalleIdx}`);
        const asignacionesData = [];
        
        let asignacionesCompletas = true;
        asignacionesContainer.querySelectorAll('div[id^="asignacion-"]').forEach(asignacionDiv => {
            const tipoEnsayoSelect = asignacionDiv.querySelector('select[name="tipo_ensayo_id"]');
            const tecnicoSelect = asignacionDiv.querySelector('select[name="tecnico_id"]');
            const asignacionPk = asignacionDiv.querySelector('input[name="asignacion_pk"]')?.value || null;

            if (tipoEnsayoSelect.value && tecnicoSelect.value) {
                asignacionesData.push({
                    asignacion_pk: asignacionPk,
                    tipo_ensayo_id: tipoEnsayoSelect.value,
                    tecnico_id: tecnicoSelect.value
                });
            } else if (tipoEnsayoSelect.value || tecnicoSelect.value) {
                asignacionesCompletas = false;
            }
        });
        
        if (asignacionesContainer.children.length > 0 && !asignacionesCompletas) {
            alert(`La Tarea #${parseInt(detalleIdx) + 1} tiene asignaciones incompletas. Por favor, complete Tipo y T√©cnico en todas las asignaciones.`);
            isValid = false;
            firstInvalidCard = card;
            return;
        }
        
        if (asignacionesData.length === 0) {
            alert(`La Tarea #${parseInt(detalleIdx) + 1} debe tener al menos una asignaci√≥n de Tipo/T√©cnico v√°lida.`);
            isValid = false;
            firstInvalidCard = card;
            return;
        }
        
        detalles.push({
            detalle_pk: card.getAttribute('data-pk') || null, 
            descripcion: descripcionInput.value,
            fecha_limite: fechaLimiteInput.value,
            norma_id: card.querySelector('select[name="norma"]').value || null,
            metodo_id: card.querySelector('select[name="metodo"]').value || null,
            observaciones_detalle: card.querySelector('textarea[name="observaciones_detalle"]').value,
            cotizacion_detalle_id: card.querySelector('input[name="cotizacion_detalle_id"]').value || null,
            cantidad: cantidadInput.value, // Aseguramos que la cantidad se env√≠e
            asignaciones: asignacionesData
        });
    });
    
    if (!isValid) {
        if (firstInvalidCard) {
            firstInvalidCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        return null;
    }

    const generadaPor = document.getElementById('generada_por_id')?.value;
    const fechaEntrega = document.getElementById('fecha_entrega_programada')?.value;

    if (!generadaPor) {
        alert('Por favor, complete el campo "Generada Por".');
        return null;
    }
    
    const formData = new FormData(form);
    return {
        csrfmiddlewaretoken: formData.get('csrfmiddlewaretoken'),
        generada_por_id: generadaPor,
        fecha_entrega_programada: fechaEntrega,
        detalles_ensayo_json: JSON.stringify(detalles),
    };
}

/**
    * Funci√≥n principal para enviar la solicitud de guardado.
    */
function guardarSolicitud() {
    const form = document.getElementById('solicitud-form');
    const submitButton = document.getElementById('submit-button');
    const loadingSpinner = document.getElementById('loading-spinner');
    const responseMessage = document.getElementById('response-message');
    // const solicitudIdInput = document.getElementById('solicitud-id'); // Comentado si no existe

    const dataToSend = colectarYValidarDatos(form);

    if (!dataToSend) {
        return; 
    }

    if (submitButton) submitButton.disabled = true;
    if (loadingSpinner) loadingSpinner.classList.remove('hidden');
    if (responseMessage) responseMessage.innerHTML = '';
    
    fetch(form.action, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            // Aseg√∫rate de que el token est√© disponible si se usa
            'X-CSRFToken': dataToSend.csrfmiddlewaretoken 
        },
        body: new URLSearchParams(dataToSend)
    })
    .then(response => {
        if (!response.ok) {
            return response.text().then(text => {
                let message = `Error del Servidor (${response.status}).`;
                try {
                    const errorJson = JSON.parse(text);
                    message = errorJson.message || message;
                } catch (e) {
                    message = `Error ${response.status}: El servidor devolvi√≥ una respuesta no JSON.`;
                    console.error("Respuesta de error no JSON:", text);
                }
                throw new Error(message);
            });
        }
        return response.json();
    })
    .then(body => {
        if (body.success) {
            // Mensaje de √©xito estilizado con Tailwind (Adaptado a tema claro)
            if (responseMessage) responseMessage.innerHTML = `
                <p class="p-3 bg-green-100 text-green-700 rounded-lg border border-green-300 font-bold flex items-center shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    √âxito: ${body.message}
                </p>
            `;
            
            // üöÄ L√ìGICA DE REDIRECCI√ìN
            if (body.redirect_url) {
                window.location.href = body.redirect_url;
            } else {
                // if (solicitudIdInput) solicitudIdInput.value = body.solicitud_id;
                setTimeout(() => {
                    if (responseMessage) responseMessage.innerHTML = ''; 
                }, 5000);
            }

        } else {
            // Mensaje de error estilizado con Tailwind (Adaptado a tema claro)
            if (responseMessage) responseMessage.innerHTML = `
                <p class="p-3 bg-red-100 text-red-700 rounded-lg border border-red-300 font-bold flex items-center shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    ‚ùå Error: ${body.message}
                </p>
            `;
        }
    })
    .catch(error => {
        // Error de conexi√≥n/operaci√≥n estilizado (Adaptado a tema claro)
        if (responseMessage) responseMessage.innerHTML = `
            <p class="p-3 bg-red-100 text-red-700 rounded-lg border border-red-300 font-bold flex items-center shadow-md">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                ‚ùå Error de Operaci√≥n: ${error.message}
            </p>
        `;
    })
    .finally(() => {
        if (submitButton) submitButton.disabled = false;
        if (loadingSpinner) loadingSpinner.classList.add('hidden');
    });
}

// ====================================================================
// 5. INICIALIZACI√ìN (Sin cambios)
// ====================================================================

window.agregarDetalle = agregarDetalle;
window.removerDetalle = removerDetalle;
window.agregarAsignacion = agregarAsignacion;
window.removerAsignacion = removerAsignacion;
window.guardarSolicitud = guardarSolicitud;

document.addEventListener('DOMContentLoaded', cargarDetallesExistentes);
</script>
{% endblock content %}