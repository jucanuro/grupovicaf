{% extends 'base_vicafpro.html' %}

{% block content %}
<style>
    .animated-gradient-text {
        background: linear-gradient(to right, #10B981, #3B82F6, #8B5CF6);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        text-fill-color: transparent;
        background-size: 200% auto;
        animation: text-gradient 3s linear infinite alternate;
    }

    @keyframes text-gradient {
        to { background-position: 200% center; }
    }

    .status-pill {
        display: inline-flex;
        align-items: center;
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-size: 0.72rem;
        font-weight: 700;
        border-width: 1px;
        text-transform: uppercase;
    }
</style>

<div class="border-b border-gray-200 pb-4 mb-6">
    <header class="flex flex-col md:flex-row items-start md:items-center justify-between gap-6">
        <div>
            <h1 class="flex text-xl font-extrabold animated-gradient-text"> 
                Bandeja de Solicitudes de Ensayo
                <svg class="h-6 w-6 ml-4 fill-sky-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path d="M184.6 475.5C181.5 482.8 179.2 490.4 177.8 498.1C163.3 506.9 146.3 512 128 512C75 512 32 469 32 416L32 128C14.3 128 0 113.7 0 96C0 78.3 14.3 64 32 64L224 64C241.7 64 256 78.3 256 96C256 113.7 241.7 128 224 128L224 383.6L184.6 475.5zM96 128L96 256L160 256L160 128L96 128zM352 64L512 64C529.7 64 544 78.3 544 96C544 113.7 529.7 128 512 128L512 281.4L603.3 494.4C605.6 499.8 607.1 505.5 607.7 511.4L608 512L607.7 512C607.9 513.8 608 515.6 608 517.4C608 549.7 581.8 576 549.4 576L282.5 576C250.2 576 223.9 549.8 223.9 517.4C223.9 515.6 224 513.8 224.2 512L223.9 512L224.2 511.4C224.8 505.6 226.3 499.8 228.6 494.4L320 281.4L320 128C302.3 128 288 113.7 288 96C288 78.3 302.3 64 320 64L352 64zM453.2 306.6C449.8 298.6 448 290.1 448 281.4L448 128L384 128L384 281.4C384 290.1 382.2 298.6 378.8 306.6L345.6 384L486.3 384L453.1 306.6z"/></svg>
            </h1>
            <p class="text-sm text-gray-500 mt-1">Listado de ítems individuales por solicitud de ensayo.</p>
        </div>
        {% for solicitud in lista_solicitudes %}
    <div class="flex gap-3">
        {# Verificamos que exista la muestra antes de intentar crear la URL #}
        {% if solicitud.muestra %}
            <a href="{% url 'proyectos:gestion_solicitud_ensayo' muestra_pk=solicitud.muestra.pk %}" 
               class="inline-flex items-center gap-2 px-4 py-2 bg-white text-gray-700 font-semibold rounded-lg hover:bg-gray-50 transition-all border border-gray-300 shadow-sm">
                <i data-lucide="plus" class="w-4 h-4"></i> Nueva
            </a>
        {% else %}
            <span class="text-xs text-red-500">Sin muestra vinculada</span>
        {% endif %}
    </div>
{% endfor %}
    </header>
</div>

<div class="mt-6 w-full rounded-lg">
    <div class="bg-white shadow-xl rounded-lg text-gray-800 border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left text-gray-700 border-separate">
                <thead class="text-xs uppercase bg-gray-50 text-gray-600 font-bold">
                    <tr>
                        <th class="py-4 px-6 border-b">Muestra / Solicitud</th>
                        <th class="py-4 px-6 border-b">Ensayo solicitado</th>
                        <th class="py-4 px-6 border-b">Estado</th>
                        <th class="py-4 px-6 border-b">Técnico Responsable</th>
                        <th class="py-4 px-6 border-b">Fecha Límite</th>
                        <th class="py-4 px-6 border-b text-center">Acciones</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100">
                    {% for solicitud in solicitudes %}
                        {# USAMOS EL RELATED NAME: detalles_ensayo #}
                        {% for detalle in solicitud.detalles_ensayo.all %}
                        <tr class="hover:bg-blue-50/40 transition-colors duration-200">
                            <td class="py-4 px-6">
                                <div class="font-bold text-blue-700 font-mono tracking-tighter">
                                    {{ solicitud.muestra.codigo_muestra|default:"SIN MUESTRA" }}
                                </div>
                                <div class="text-[10px] text-gray-400 uppercase font-bold">
                                    {{ solicitud.codigo_solicitud }}
                                </div>
                            </td>

                            <td class="py-4 px-6">
                                <div class="font-semibold text-gray-900 leading-tight">
                                    {{ detalle.tipo_ensayo_descripcion }}
                                </div>
                                <div class="text-[11px] text-gray-500">
                                    {{ detalle.metodo.nombre|default:"Método Estándar" }}
                                </div>
                            </td>

                            <td class="py-4 px-6">
                                {% if detalle.estado_detalle == 'VALIDADO' %}
                                    <span class="status-pill bg-green-50 text-green-700 border-green-200">
                                        <i data-lucide="check-check" class="w-3 h-3 mr-1"></i> Validado
                                    </span>
                                {% elif detalle.estado_detalle == 'COMPLETADO' %}
                                    <span class="status-pill bg-blue-50 text-blue-700 border-blue-200">
                                        <i data-lucide="clipboard-check" class="w-3 h-3 mr-1"></i> Completado
                                    </span>
                                {% elif detalle.estado_detalle == 'EN_EJECUCION' %}
                                    <span class="status-pill bg-purple-50 text-purple-700 border-purple-200">
                                        <i data-lucide="flask-conical" class="w-3 h-3 mr-1"></i> En Ejecución
                                    </span>
                                {% else %}
                                    <span class="status-pill bg-orange-50 text-orange-700 border-orange-200">
                                        <i data-lucide="clock" class="w-3 h-3 mr-1"></i> Pendiente
                                    </span>
                                {% endif %}
                            </td>

                            <td class="py-4 px-6">
                                <div class="flex items-center">
                                    {% with asignacion=detalle.asignaciones.first %}
                                        {% if asignacion %}
                                            <div class="flex flex-col">
                                                <span class="text-xs font-bold text-blue-700">
                                                    {{ asignacion.tecnico_asignado.nombre_completo }}
                                                </span>
                                                <span class="text-[10px] text-gray-400">
                                                    {{ asignacion.tipo_ensayo.nombre|truncatechars:15 }}
                                                </span>
                                            </div>
                                        {% else %}
                                            <span class="text-xs text-gray-400 italic">No asignado</span>
                                        {% endif %}
                                    {% endwith %}
                                </div>
                            </td>

                            <td class="py-4 px-6">
                                <div class="text-xs {% if detalle.estado_detalle != 'VALIDADO' %}text-red-600 font-medium{% else %}text-gray-500{% endif %}">
                                    {{ detalle.fecha_limite_ejecucion|date:"d/m/Y" }}
                                </div>
                            </td>

                            <td class="py-4 px-6 text-center">
                                <a href="/proyectos/ensayo/registrar/?detalle_id={{ detalle.id }}" 
                                class="inline-flex items-center px-4 py-2 text-xs font-bold rounded-lg border transition-all
                                {% if detalle.estado_detalle == 'PENDIENTE' or detalle.estado_detalle == 'ASIGNADO' or detalle.estado_detalle == 'EN_EJECUCION' %}
                                    bg-orange-600 text-white border-orange-600 hover:bg-orange-700
                                {% else %}
                                    bg-white text-blue-700 border-blue-200 hover:bg-blue-600 hover:text-white
                                {% endif %}">
                                    
                                    <i data-lucide="clipboard-edit" class="w-4 h-4 mr-2"></i>
                                    
                                    {% if detalle.estado_detalle == 'COMPLETADO' or detalle.estado_detalle == 'VALIDADO' %}
                                        Gestionar
                                    {% else %}
                                        Registrar
                                    {% endif %}
                                </a>
                            </td>
                        </tr>
                        {% endfor %}
                    {% empty %}
                        <tr>
                            <td colspan="6" class="py-20 text-center text-gray-400 bg-gray-50/50">
                                <i data-lucide="search-x" class="w-12 h-12 mx-auto mb-4 opacity-20"></i>
                                <p class="text-lg">No hay solicitudes para mostrar</p>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        if (typeof lucide !== 'undefined') lucide.createIcons();
    });
</script>
{% endblock content %}