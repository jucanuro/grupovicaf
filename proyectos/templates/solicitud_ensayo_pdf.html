{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Solicitud de Ensayo N° {{ solicitud.codigo_solicitud|default:"PENDIENTE" }}</title>
    <style>
        /* =========================================================
           CONFIGURACIÓN DE PÁGINA (XHTML2PDF)
           ========================================================= */
        @page {
            size: A4;
            margin: 3cm 1.5cm 3cm 1.5cm; /* Margen para contenido principal */

            /* Marco para el ENCABEZADO (Se adapta a VCF-LAB-FOR-068) */
            @frame header_frame {
                -pdf-frame-content: header_content;
                top: 1cm;
                left: 1.5cm;
                width: 18cm;
                height: 1.5cm;
            }

            /* Marco para el PIE DE PÁGINA */
            @frame footer_frame {
                -pdf-frame-content: footer_content;
                bottom: 1cm;
                left: 1.5cm;
                width: 18cm;
                height: 1.5cm;
            }
        }

        /* =========================================================
           ESTILOS GENERALES
           ========================================================= */
        body {
            font-family: Helvetica, Arial, sans-serif;
            font-size: 9px;
            color: #000;
            line-height: 1.3;
        }

        .font-bold { font-weight: bold; }
        .text-right { text-align: right; }
        .text-center { text-align: center; }
        .corporate-blue { color: #004D99; }
        
        /* Tablas */
        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        td, th { vertical-align: top; }

        /* Contenido de Marcos Estáticos */
        #header_content {
            font-size: 8px;
            text-align: right;
            color: #000;
            padding-bottom: 5px;
        }

        #footer_content {
            font-size: 9px;
            text-align: center;
            color: #000;
            padding-top: 5px;
            
        }

        /* Componentes Específicos */
        .logo-img {
            width: 180px; 
            height: auto;
        }
        .company-box {
            border: 1px solid #000;
            padding: 8px;
            font-size: 9px;
        }

        .offer-title-box {
            border: 1px solid #000;
            padding: 5px;
            margin: 10px 0;
        }
        .offer-title-text {
            font-weight: bold;
            font-size: 14px;
            color: #004D99;
            text-align: center;
            margin-bottom: 5px;
        }

        /* Estilos de Tablas de Datos */
        .client-table td {
            border: 1px solid #000;
            padding: 3px 5px;
        }
        
        .items-table th {
            background-color: #f0f0f0;
            border: 1px solid #000;
            text-align: center;
            font-weight: bold;
            font-size: 8px;
            padding: 4px;
        }
        .items-table td {
            border: 1px solid #000;
            padding: 4px;
            font-size: 9px;
        }

        .section-title {
            font-weight: bold;
            margin-top: 10px;
            margin-bottom: 5px;
            text-transform: uppercase;
            font-size: 10px;
            border-bottom: 1px solid #000;
            padding-bottom: 2px;
        }
        
        /* Firmas */
        .signature-box {
            margin-top: 30px;
            text-align: center;
            width: 230px;
        }
        .signature-line {
            border-top: 1px solid #000;
            margin-top: 5px;
            margin-bottom: 5px;
        }
        .signature-img-dynamic {
            height: 70px; 
            margin-bottom: -10px;
        }

        /* Paginación automática */
        .page-number:after { content: counter(page); }
        .page-count:after { content: counter(pages); }
    </style>
</head>
<body>

    <div id="header_content">
        Código: VCF-LAB-FOR-068 | Fecha: 10/11/2023 | Versión: 02 | Página <span class="page-number"></span> de <span class="page-count"></span>
    </div>

    <div id="footer_content">
        <div style="border-top: 1px solid #000; width: 100%; margin-bottom: 5px;"></div>
        +51 941 573 750 | informes@grupovicaf.com <br>
        <strong>GRUPO VICAF SAC</strong>
    </div>

    <table style="margin-bottom: 10px; border: none;">
        <tr>
            <td style="width: 45%; vertical-align: middle; text-align: center; border: none;">
                <img src="{% static 'img/LogoF.png' %}" class="logo-img" alt="Logo">
            </td>
            <td style="width: 55%; border: none;">
                <div class="company-box">
                    <strong>Razón Social:</strong> Grupo Vicaf SAC<br>
                    <strong>RUC:</strong> 20609464632<br>
                    <strong>Dirección:</strong> JR. LOS TOPACIOS 440 - CAJAMARCA<br>
                    <strong>Teléfono:</strong> 960 713 555 | <strong>Cel:</strong> +51 941 573 750<br>
                    <strong>Email:</strong> informes@grupovicaf.com
                </div>
            </td>
        </tr>
    </table>

    <div class="offer-title-box">
        <div class="offer-title-text" style="font-size: 16px;">
            SOLICITUD DE ENSAYOS DE SUELOS, AGREGADOS, ROCAS Y AGUA 
        </div>
        <table style="width: 100%; border: none; margin: 0;">
            <tr>
                <td style="border: none; font-weight: bold;">SOLICITUD No. {{ solicitud.codigo_solicitud|default:"PENDIENTE" }}</td>
                <td style="border: none; text-align: right; font-weight: bold;"></td>
            </tr>
        </table>
    </div>

    <div class="section-title">1. DATOS GENERALES DEL SERVICIO</div>
    <table class="client-table">
        <tr>
            <td style="width: 20%; background-color: #f0f0f0;"><strong>Cliente:</strong></td>
            <td style="width: 30%;">{{ solicitud.muestra.proyecto.cliente.razon_social|default:"-" }}</td>
            <td style="width: 20%; background-color: #f0f0f0;"><strong>Fecha de Solicitud:</strong></td>
            <td style="width: 30%;">{{ solicitud.fecha_solicitud|date:"d/m/Y"|default:"-" }}</td>
        </tr>
        <tr>
            <td style="background-color: #f0f0f0;"><strong>Proyecto:</strong></td>
            <td>{{ solicitud.muestra.proyecto.nombre_proyecto|default:"-" }}</td>
            <td style="background-color: #f0f0f0;"><strong>Ubicación:</strong></td>
            <td>{{ solicitud.muestra.proyecto.ubicacion|default:"-" }}</td>
        </tr>
        <tr>
            <td style="background-color: #f0f0f0;"><strong>Contacto:</strong></td>
            <td>{{ solicitud.persona_contacto|default:"-" }}</td>
            <td style="background-color: #f0f0f0;"><strong>Entrega Programada:</strong></td>
            <td>{{ solicitud.fecha_entrega_programada|date:"d/m/Y"|default:"-" }}</td>
        </tr>
    </table>
    
    <div class="section-title">2. DETALLE DE SOLICITUD DE ENSAYO</div>
<table class="items-table">
    <thead>
        <tr>
            <th style="width: 5%;">ÍTEM</th>
            <th style="width: 15%;">CÓDIGO DE MUESTRA</th>
            <th style="width: 35%;">DESCRIPCIÓN DE ENSAYO</th>
            <th style="width: 12%;">NORMA</th>
            <th style="width: 10%;">MÉTODO</th>
            <th style="width: 13%;">TÉCNICO ASIGNADO</th>
            <th style="width: 10%;">CANTIDAD</th>
        </tr>
    </thead>
    <tbody>
        {% for detalle in items_ensayo %}
        <tr>
            <td class="text-center">{{ forloop.counter }}</td>
            
            <td>
                {{ detalle.solicitud.muestra.codigo_laboratorio|default:detalle.solicitud.muestra.codigo_muestra|default:"PENDIENTE" }}
            </td>
            
            <td>
                <strong>{{ detalle.tipo_ensayo_descripcion|default:"Ensayo sin nombre" }}</strong>
                {% if detalle.observaciones_detalle %}
                <br><span style="font-size: 8px;">Obs: {{ detalle.observaciones_detalle }}</span>
                {% endif %}
            </td>
            <td>{{ detalle.norma.nombre|default:"-" }}</td>
            <td>{{ detalle.metodo.nombre|default:"-" }}</td>
            <td>
                {% with asignacion=detalle.asignaciones.all.0 %}
                    {{ asignacion.tecnico_asignado.nombre_completo|default:"-" }}
                {% endwith %}
            </td>
            <td class="text-center">{{ detalle.cantidad|floatformat:0|default:"1" }}</td>
        </tr>
        {% endfor %}

        {% with total_items=items_ensayo|length %}
        {% if total_items < 5 %}
            {% for i in ""|ljust:5|make_list|slice:total_items|add:"-"|cut:"-"|make_list %}
            <tr>
                <td style="height: 15px;"></td> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td> </tr>
            {% endfor %}
        {% endif %}
        {% endwith %}

    </tbody>
</table>

    <div class="section-title">3. OBSERVACIONES Y TIPO DE INFORME</div>
    <table class="client-table">
        <tr>
            <td style="width: 25%; background-color: #f0f0f0;"><strong>Observaciones de la Solicitud:</strong></td>
            <td style="width: 75%;">{{ solicitud.observaciones|default:"Ninguna." }}</td>
        </tr>
        <tr>
            <td style="background-color: #f0f0f0;"><strong>Tipo de Informe Requerido:</strong></td>
            <td>{{ solicitud.tipo_informe_requerido|default:"Informe simple" }}</td>
        </tr>
    </table>
    
    <div style="margin-top: 30px; width: 100%;">
        
        <div class="signature-box" style="float: right; text-align: center;">
            <div style="text-align: left; margin-bottom: 0px; padding-left: 5px; font-size: 10px;">
                V°B° Jefe de Laboratorio,
            </div>

            {% with responsable=jefe_laboratorio %}
            {% if responsable and responsable.firma_electronica %}
                <img src="{{ responsable.firma_electronica.url }}" class="signature-img-dynamic" style="margin-bottom: -5px; height: 65px;">
            {% else %}
                <div style="height: 65px;"></div>
            {% endif %}
            
            <div class="signature-line"></div>
            
            <div style="line-height: 1.2;">
                <strong>{{ responsable.titulo_profesional|default:"Ing." }} {{ responsable.nombre_completo|default:"[Jefe de Laboratorio]" }}</strong><br>
                {{ responsable.role|default:"Jefe de Laboratorio" }}<br>
                <span class="corporate-blue font-bold">GRUPO VICAF SAC</span>
            </div>
            {% endwith %}
        </div>
        
        <div class="signature-box" style="float: left; text-align: center;">
            <div style="text-align: left; margin-bottom: 0px; padding-left: 5px; font-size: 10px;">
                Elabora la Solicitud:
            </div>
            
            {% with elaborador=solicitud.generada_por.trabajadorprofile %}
            {% if elaborador and elaborador.firma_electronica %}
                <img src="{{ elaborador.firma_electronica.url }}" class="signature-img-dynamic" style="margin-bottom: -5px; height: 65px;">
            {% else %}
                <div style="height: 65px;"></div>
            {% endif %}
            
            <div class="signature-line"></div>
            
            <div style="line-height: 1.3;">
                <strong>{{ elaborador.nombre_completo|default:"[Nombre del Elaborador]" }}</strong><br>
                {{ elaborador.role|default:"[Rol del Elaborador]" }}
            </div>
            {% endwith %}
        </div>

        <div style="clear: both;"></div>
    </div>

</body>
</html>